"use strict";function textAreaAdjust(t){t.style.height="1px",t.style.height=25+t.scrollHeight+"px"}!function(t,o){return"function"==typeof define&&define.amd?void define("pdf-annotation",["angular"],function(t){return o(t)}):o(t)}("undefined"==typeof angular?null:angular,function(t){var o=t.module("pdfAnnotation",[]);o.factory("pdfAnnotationFactory",function(){var o,i,s,n,e,a,r,h,p={};return p.options={viewport:"",canvas_rand:"",ctx_rand:"",renderContext:{canvasContext:"",viewport:""},bindFlag:"",btnFlag:!1,bindCnt:0,pdfOptions:{},toolsObj:{},optionArrData:{startX:[],startY:[],endX:[],endY:[],pencilData:[]},pdfWorker:"src/js/pdf.worker.js",actionListObj:[]},p.history={options:{canvas_width:"",canvas_height:"",activePage:0,totalPage:1,enablePrevBtn:!1,enableNextBtn:!1,font_size:18,fillStyle:"FF0000",lineWidth:2,undoFlag:!1,redoFlag:!1,arrData:{startX:[],startY:[],endX:[],endY:[],pencilData:[]}},initial_canvas_url:[],final_canvas_url:[],redo_list:[],undo_list:[],raw_undo_list:[],raw_redo_list:[],raw_undo_ver_list:[],raw_redo_ver_list:[],tmp_raw_undo_list:"",setStyleElement:function(t,o){o.fillStyle="#"+this.options.fillStyle.replace("#",""),o.font=this.options.font_size+"px Calibri",o.lineWidth=this.options.lineWidth,o.strokeStyle="#"+this.options.fillStyle.replace("#","")},resetStyleElement:function(){this.options.fillStyle=document.getElementById("fillstyle").value,this.options.font_size=document.getElementById("fontsize").value,this.options.lineWidth=document.getElementById("linewidth").value},setButtonStyle:function(){this.raw_undo_ver_list.length>0?(this.raw_undo_ver_list[this.options.activePage].length>0||this.raw_undo_list[this.options.activePage].length>0?p.options.toolsObj.undo.classList.remove("cur_disable"):p.options.toolsObj.undo.className+=" cur_disable",0===this.raw_redo_ver_list.length&&(this.raw_redo_ver_list[this.options.activePage]=[]),this.raw_redo_ver_list[this.options.activePage].length>0?p.options.toolsObj.redo.classList.remove("cur_disable"):p.options.toolsObj.redo.className+=" cur_disable"):(p.options.toolsObj.undo.className+=" cur_disable",p.options.toolsObj.redo.className+=" cur_disable")},saveState:function(o,i,s){s=s||!1,s||(this.redo_list=[]),this.undo_list.hasOwnProperty(this.options.activePage)||(this.undo_list[this.options.activePage]=[]),this.raw_undo_list.hasOwnProperty(this.options.activePage)||(this.raw_undo_list[this.options.activePage]=[],this.raw_redo_list[this.options.activePage]=[],this.raw_undo_ver_list[this.options.activePage]=[],this.raw_redo_ver_list[this.options.activePage]=[]);var n=o.toDataURL();if(i)i.hasOwnProperty(this.options.activePage)||(i[this.options.activePage]=[]),i[this.options.activePage][0]=n;else if(this.undo_list[this.options.activePage][0]=n,p.event.options.activeTool&&"move"!==p.event.options.activeTool.name)this.saveRawData();else if(""!=this.tmp_raw_undo_list){var e=t.copy(this.tmp_raw_undo_list);this.tmp_raw_undo_list="",0===this.raw_undo_ver_list.length&&(this.raw_undo_ver_list[this.options.activePage]=[]),this.raw_undo_ver_list[this.options.activePage].push(e)}this.setButtonStyle(),p.history.final_canvas_url[p.history.options.PrevPage]=n},saveRawData:function(){if(!p.event.options.activeTool.drawing){if(this.raw_undo_list.hasOwnProperty(this.options.activePage)||(this.raw_undo_list[this.options.activePage]=[],this.raw_redo_list[this.options.activePage]=[],this.raw_undo_ver_list[this.options.activePage]=[],this.raw_redo_ver_list[this.options.activePage]=[]),0===this.raw_undo_ver_list.length&&(this.raw_undo_ver_list[this.options.activePage]=[]),this.raw_undo_list[this.options.activePage].length>0){var o=t.copy(this.raw_undo_list[this.options.activePage]);this.raw_undo_ver_list[this.options.activePage].push(o)}var i=t.copy(this.options.arrData);i.name&&""!=i.name&&(this.raw_undo_list[this.options.activePage][this.raw_undo_list[this.options.activePage].length]=i,this.options.undoFlag=!0),p.options.optionArrData=this.options.arrData={startX:[],startY:[],endX:[],endY:[],pencilData:[]}}},setRawData:function(){p.options.optionArrData.name=p.event.options.activeTool.name,p.options.optionArrData.startX.push(p.event.options.activeTool.options.startX),p.options.optionArrData.startY.push(p.event.options.activeTool.options.startY),p.options.optionArrData.endX.push(p.event.options.activeTool.options.endX),p.options.optionArrData.endY.push(p.event.options.activeTool.options.endY),p.options.optionArrData.font_size=this.options.font_size,p.options.optionArrData.fillStyle=this.options.fillStyle,p.options.optionArrData.lineWidth=this.options.lineWidth,"text"===p.options.optionArrData.name&&(p.options.optionArrData.textInfo=p.event.options.activeTool.options.textInfo,p.options.optionArrData.finalTextInfo=p.event.options.activeTool.options.finalTextInfo),"image"===p.options.optionArrData.name&&(p.options.optionArrData.imageURL=p.event.options.activeTool.options.uploadedImage[p.event.options.activeTool.options.uploadedImage.length-1]),"circle"===p.options.optionArrData.name&&(p.options.optionArrData.radius=p.event.options.activeTool.options.radius),"pencil"===p.options.optionArrData.name&&p.options.optionArrData.pencilData.push({x:p.event.options.activeTool.options.startX,y:p.event.options.activeTool.options.startY}),"line"===p.options.optionArrData.name&&(p.options.optionArrData.lineAngle=Math.atan2(p.event.options.activeTool.options.endY-p.event.options.activeTool.options.startY,p.event.options.activeTool.options.endX-p.event.options.activeTool.options.startX)),"arrow"===p.options.optionArrData.name&&(p.options.optionArrData.arrowAngle=Math.atan2(p.event.options.activeTool.options.endY-p.event.options.activeTool.options.startY,p.event.options.activeTool.options.endX-p.event.options.activeTool.options.startX)),this.options.arrData=t.copy(p.options.optionArrData)},undo:function(t,o){this.raw_undo_list.length>0&&(this.options.action="undo",this.restoreStateRawData(this.raw_undo_list,this.raw_redo_list),this.redrawState(t,o))},redo:function(t,o){this.raw_redo_ver_list[this.options.activePage].length>0&&(this.options.action="redo",this.restoreStateRawData(this.raw_undo_list,this.raw_redo_list),p.move.init(t,o),this.redrawState(t,o))},restoreState:function(t,o,i,s){var n=i[this.options.activePage];if(n.length){if(s&&"undo"==this.options.action&&this.saveState(t,s,!0),"undo"==this.options.action){var e=n.pop();if(n.length)var a=n[n.length-1];else var a=e}else{var e=n.pop(),a=e;this.undo_list[this.options.activePage].push(e)}var r=document.createElement("img");r.src=a,r.onload=function(){o.clearRect(0,0,p.history.options.canvas_width,p.history.options.canvas_height),o.drawImage(r,0,0,p.history.options.canvas_width,p.history.options.canvas_height)}}},restoreStateRawData:function(o,i){var s=o[this.options.activePage];if("undo"==this.options.action){if(this.raw_undo_ver_list[this.options.activePage].length>0){var n=t.copy(s);if(this.raw_redo_ver_list[this.options.activePage].push(n),this.options.redoFlag=!0,this.raw_undo_ver_list[this.options.activePage].length>0){var e=t.copy(this.raw_undo_ver_list[this.options.activePage].pop());this.raw_undo_list[this.options.activePage]=e}}else if(this.options.undoFlag===!0){var n=t.copy(s);this.raw_redo_ver_list[this.options.activePage].push(n),this.raw_undo_list[this.options.activePage]=[],this.options.undoFlag=!1}this.setButtonStyle()}else{if(this.raw_redo_ver_list[this.options.activePage].length>0){if(this.raw_undo_list[this.options.activePage].length>0){var n=t.copy(this.raw_undo_list[this.options.activePage]);this.raw_undo_ver_list[this.options.activePage].push(n)}if(this.options.undoFlag=!0,this.raw_redo_ver_list[this.options.activePage].length>0){var a=t.copy(this.raw_redo_ver_list[this.options.activePage].pop()),r=a;this.raw_undo_list[this.options.activePage]=r}}else if(this.options.redoFlag===!0){var a=t.copy(this.raw_redo_ver_list[this.options.activePage].pop()),r=a;this.raw_undo_list[this.options.activePage]=r,this.options.redoFlag=!1}this.setButtonStyle()}},drawingState:function(t,o,i){if(i[this.options.activePage].length){var s=i[this.options.activePage][i[this.options.activePage].length-1],n=document.createElement("img");n.src=s,n.onload=function(){o.clearRect(0,0,p.history.options.canvas_width,p.history.options.canvas_height),o.drawImage(n,0,0,p.history.options.canvas_width,p.history.options.canvas_height),p.event.options.activeTool.drawTool()}}},redrawState:function(t,o){if(this.initial_canvas_url[this.options.activePage]){var i=this.initial_canvas_url[this.options.activePage],s=document.createElement("img");s.src=i,s.onload=function(){p.move.ctx.clearRect(0,0,p.history.options.canvas_width,p.history.options.canvas_height),p.move.ctx.drawImage(s,0,0,p.history.options.canvas_width,p.history.options.canvas_height),p.history.raw_undo_list[p.history.options.activePage].length>0&&p.move.redrawTool()}}},manageActiveBtn:function(t){for(var o=document.getElementsByClassName("controller active"),i=0;i<o.length;i++)o[i].classList.remove("active");""!==t&&(document.getElementById(t).className+=" active","clear_image"!==t&&p.options.toolsObj.frm_canvas_tool.reset())}},p.event={options:{activeTool:""},init:function(t,o){this.canvas=t,this.canvas_coords=this.canvas.getBoundingClientRect(),this.ctx=o,this.ctx.strokeColor=this.options.stroke_color,this.paging(),this.addCanvasEvents()},addCanvasEvents:function(){this.canvas.addEventListener("mousedown",this.start.bind(this)),this.canvas.addEventListener("mousemove",this.stroke.bind(this)),this.canvas.addEventListener("mouseup",this.stop.bind(this)),this.canvas.addEventListener("mouseout",this.stop.bind(this))},start:function(t){p.move.options.selectedObject=-1,p.move.options.movedObject=-1,p.history.raw_undo_list[p.history.options.activePage].length>0&&(p.move.init(this.canvas,this.ctx),p.move.start(t)),p.move.options.movedObject==-1&&""!==this.options.activeTool&&void 0!==this.options.activeTool&&this.options.activeTool.start(t)},stroke:function(t){""!==this.options.activeTool&&void 0!==this.options.activeTool&&this.options.activeTool.drawing===!0&&this.options.activeTool.stroke(t)},stop:function(t){""!==this.options.activeTool&&void 0!==this.options.activeTool&&this.options.activeTool.drawing===!0&&this.options.activeTool.stop(t)},closepdf:function(){p.options.closeFn()},savepdf:function(t){var o=0,i=new jsPDF("p","mm","a4");for(o=0;o<parseInt(p.history.options.totalPage);o++)if(o<2){if(this.options.isSave=!0,p.move.init(this.canvas,this.ctx),p.move.redrawTool(),p.history.final_canvas_url.hasOwnProperty(o))var s=p.history.final_canvas_url[o];else var s=document.getElementById("page"+o).toDataURL("image/png");i.addImage(s,"PNG",0,0,200,250,null,"SLOW"),o<parseInt(p.history.options.totalPage-1)&&i.addPage(),this.options.isSave=!1}var n=i.output("datauristring"),e=this.dataURLtoBlob(n);"function"==typeof p.options.callbackFn?p.options.callbackFn({blob:e,flag:t,actionListObj:p.history.raw_undo_list}):i.save()},dataURLtoBlob:function(t){for(var o=t.split(","),i=o[0].match(/:(.*?);/)[1],s=atob(o[1]),n=s.length,e=new Uint8Array(n);n--;)e[n]=s.charCodeAt(n);return new Blob([e],{type:i})},paging:function(){p.history.options.totalPage=p.history.options.pdfobj.transport.numPages,p.options.toolsObj.activePage.textContent=p.history.options.activePage+1,p.options.toolsObj.currentPage.value=p.history.options.activePage+1,p.options.toolsObj.totalPage.textContent=p.history.options.totalPage,p.history.options.totalPage>1?0===p.history.options.activePage?(p.options.toolsObj.prevBtn.setAttribute("disabled","disabled"),p.options.toolsObj.nextBtn.removeAttribute("disabled")):parseInt(p.history.options.activePage)===parseInt(p.history.options.totalPage-1)?(p.options.toolsObj.nextBtn.setAttribute("disabled","disabled"),p.options.toolsObj.prevBtn.removeAttribute("disabled")):p.history.options.activePage>0&&parseInt(p.history.options.activePage)<parseInt(p.history.options.totalPage-1)&&(p.options.toolsObj.prevBtn.removeAttribute("disabled"),p.options.toolsObj.nextBtn.removeAttribute("disabled")):(p.options.toolsObj.nextBtn.setAttribute("disabled","disabled"),p.options.toolsObj.prevBtn.setAttribute("disabled","disabled"))},removeObject:function(){p.move.options.selectedObject>-1&&(p.history.raw_undo_list[p.history.options.activePage].splice(p.move.options.selectedObject,1),p.move.options.selectedObject=-1,p.move.options.isSelectedObj=!1,p.history.redrawState(this.canvas,this.ctx),p.move.redrawTool(),p.history.setRawData(),p.history.saveState(this.canvas))}},p.text={name:"text",options:{stroke_color:["00","00","00"],fill_color:"#FF0000",font:"18px Arial",dim:4,lineHeight:14,finalTextInfo:[],width:250,height:250},init:function(t,o){this.canvas=t,this.ctx=o,this.ctx.strokeColor=this.options.stroke_color,this.drawing=!1,this.options.flag=!0},start:function(t){if(this.options.flag){this.canvas_coords=this.canvas.getBoundingClientRect();var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.startX=o,this.options.startY=i,this.options.endX=o,this.options.endY=i,this.ctx.fillStyle=this.options.fill_color,this.ctx.font=this.options.font,this.ctx.beginPath(),this.drawing=!0}},stroke:function(t){if(this.options.flag&&this.drawing){var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.endX=o,this.options.endY=i}},stop:function(t){this.drawing=!1,this.options.flag=!1,this.options.lineHeight=parseInt(p.history.options.font_size),p.options.toolsObj.editor_wrapper.style.display="block",p.options.toolsObj.editor_wrapper.style.top=parseInt(this.options.startY)+"px",p.options.toolsObj.editor_wrapper.style.left=this.options.startX+"px",p.options.toolsObj.editor_wrapper.style.width=this.options.width+"px",p.options.toolsObj.contenteditor.focus(),p.options.toolsObj.contenteditor.style.height="auto",this.options.finalTextInfo=[]},drawTool:function(){p.history.setStyleElement(this.canvas,this.ctx),p.options.toolsObj.contenteditor.style.fontSize=p.history.options.font_size,p.options.toolsObj.contenteditor.style.lineHeight=p.history.options.font_size+"px",p.options.toolsObj.contenteditor.style.height=p.options.toolsObj.contenteditor.scrollHeight+"px";var t=p.options.toolsObj.contenteditor.value,o=escape(t);if(t=unescape(o.replace(/%0A/g,"<br />").replace(/%20/g," ")),p.options.toolsObj.contenteditor.value="",""!=parseInt(p.options.toolsObj.contenteditor.style.width)&&parseInt(p.options.toolsObj.contenteditor.style.width)>0?p.options.toolsObj.contenteditor.style.width=parseInt(p.options.toolsObj.contenteditor.style.width):p.options.toolsObj.contenteditor.style.width=parseInt(this.options.width),""!==t){var i={text:t,x:this.options.startX+10,y:this.options.startY+20,boxWidth:parseInt(p.options.toolsObj.contenteditor.style.width)};this.drawStyledText(i)}this.options.flag=!0},drawStyledText:function(t){this.options.textInfo=t;var o,i,s,n,e,a,r=t.text,h=t.x,c=t.y,l=[],d=t.boxWidth,v=r.match(/<\s*br\s*\/>|<\s*class=["|']([^"|']+)["|']\s*\>([^>]+)<\s*\/class\s*\>|<\s*style=["|']([^"|']+)["|']\s*\>([^>]+)<\s*\/style\s*\>|[^<]+/g);for(a=0;a<v.length;a++)if(/<\s*br\s*\/>/i.test(v[a]))c+=1.5*parseInt(this.options.lineHeight,10),h=t.x;else{if(s=v[a],l=[],s=s.replace(/\s*\n\s*/g," "),void 0!==d&&this.checkLineBreak(s,d+t.x,h))if(o=this.trim(s).split(" "),1==o.length)l.push({text:this.trim(s)+" ",linebreak:!0});else{i=h;var g=0;for(l[g]={text:void 0,linebreak:!1},n=0;n<o.length;n++)o[n]+=" ",this.checkLineBreak(o[n],d+t.x,i)?(i=t.x,void 0!==l[g].text&&g++,l[g]={text:o[n],linebreak:!0},i+=this.ctx.measureText(o[n]).width):(void 0==l[g].text?l[g].text=o[n]:l[g].text+=o[n],i+=this.ctx.measureText(o[n]).width)}for(0==l.length&&l.push({text:this.trim(s)+" ",linebreak:!1}),e=0;e<l.length;e++)l[e].linebreak&&(c+=parseInt(this.options.lineHeight,10),h=t.x,this.options.endY=c),this.ctx.fillText(l[e].text,h,c),this.options.finalTextInfo.push({text:l[e].text,x:h,y:c}),h+=this.ctx.measureText(l[e].text).width}p.square.canvas=this.canvas,p.square.ctx=this.ctx,p.square.options.startX=this.options.startX,p.square.options.startY=this.options.startY,p.square.options.endX=this.options.startX+parseInt(p.options.toolsObj.contenteditor.style.width),p.square.options.endY=c+10,p.square.drawTool(),this.options.startX=this.options.startX,this.options.startY=this.options.startY,this.options.endX=this.options.startX+parseInt(p.options.toolsObj.contenteditor.style.width),this.options.endY=c+10,this.ctx.stroke(),p.history.setRawData(),p.history.saveState(this.canvas)},redrawTool:function(t,o,i){for(var s=0;s<t.length;s++)this.ctx.fillText(t[s].text,t[s].x+o,t[s].y+i);p.square.canvas=this.canvas,p.square.ctx=this.ctx,p.square.options.startX=this.options.startX,p.square.options.startY=this.options.startY,p.square.options.endX=this.options.endX,p.square.options.endY=this.options.endY,p.square.drawTool()},checkLineBreak:function(t,o,i){return this.ctx.measureText(t).width+i>o},trim:function(t){var o,i;for(t=t.replace(/^\s\s*/,""),o=/\s/,i=t.length;o.test(t.charAt(--i)););return t.slice(0,i+1)}},p.image={name:"image",options:{activeImage:"",uploadedImage:[],width:"",height:"",wdthHghtRatio:"",img:""},init:function(t,o){this.canvas=t,this.ctx=o,this.ctx.strokeColor=this.options.stroke_color,this.drawing=!1},start:function(t){this.canvas_coords=this.canvas.getBoundingClientRect();var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.startX=o,this.options.startY=i,this.options.endX=o,this.options.endY=i,this.ctx.beginPath()},stroke:function(t){if(this.drawing){p.history.drawingState(this.canvas,this.ctx,p.history.undo_list);var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.endX=o,this.options.endY=i,this.drawTool()}},stop:function(t){this.drawing&&this.options.startX!==this.options.endX&&this.options.startY!==this.options.endY?(this.ctx.beginPath(),this.drawTool(),this.ctx.closePath(),this.ctx.stroke(),this.drawing=!1,p.history.setRawData(),p.history.saveState(this.canvas)):(this.ctx.closePath(),this.ctx.stroke(),this.drawing=!1)},calculateAspectRatioFit:function(t,o,i,s){var n=Math.min(i/t,s/o),e=t*n,a=o*n;return{width:e,height:a}},drawTool:function(){this.ctx.beginPath(),p.history.setStyleElement(this.canvas,this.ctx),this.options.width=parseInt(this.options.endX-this.options.startX),this.options.height=parseInt(this.options.endY-this.options.startY);var t=this.calculateAspectRatioFit(this.options.endX,this.options.endY,this.options.width,this.options.height);this.ctx.drawImage(this.options.img,this.options.startX,this.options.startY,t.width,t.height),this.ctx.closePath(),p.event.options.isSave||(this.ctx.beginPath(),this.ctx.lineWidth=3,this.ctx.strokeStyle="#000000",this.ctx.rect(this.options.startX+2,this.options.startY+2,this.options.width-4,this.options.height-4),this.ctx.stroke(),this.ctx.closePath(),this.ctx.beginPath(),this.ctx.lineWidth=1,this.ctx.fillStyle="#FFFFFF",p.image.options.endX=p.image.options.startX+p.image.options.width,p.image.options.endY=p.image.options.startY+p.image.options.height,this.ctx.rect(p.image.options.startX,p.image.options.startY,8,8),this.ctx.rect(p.image.options.startX,p.image.options.endY-8,8,8),this.ctx.rect(p.image.options.endX-8,p.image.options.endY-8,8,8),this.ctx.rect(p.image.options.endX-8,p.image.options.startY,8,8),this.ctx.rect(p.image.options.endX-p.image.options.width,p.image.options.endY-parseInt(p.image.options.height/2)-8,8,8),this.ctx.rect(p.image.options.endX-8,p.image.options.endY-parseInt(p.image.options.height/2)-8,8,8),this.ctx.rect(p.image.options.endX-parseInt(p.image.options.width/2)-8,p.image.options.endY-8,8,8),this.ctx.rect(p.image.options.endX-parseInt(p.image.options.width/2)-8,p.image.options.endY-p.image.options.height,8,8),this.ctx.fill(),this.ctx.stroke(),this.ctx.closePath())},uploadImage:function(t){var o=new Image;o.onload=function(t){p.image.options.startX=10,p.image.options.startY=10,p.image.options.endX=this.width,p.image.options.endY=this.height,p.image.ctx.beginPath(),p.image.drawing=!0,p.history.drawingState(p.image.canvas,p.image.ctx,p.history.undo_list),p.image.drawTool(),p.image.ctx.closePath(),p.image.ctx.stroke();var o=document.createElement("canvas");o.width=this.width,o.height=this.height,o.getContext("2d").drawImage(this,0,0),p.options.saveAttachment({imageBlobObj:o.toDataURL("image/png")}),p.image.drawing=!1,p.history.setRawData(),p.history.saveState(p.image.canvas),p.options.toolsObj.frm_canvas_tool.reset()},o.src=URL.createObjectURL(t),this.options.uploadedImage.push(URL.createObjectURL(t)),this.options.img=o},resetImage:function(){this.options.img=""}},p.arrow={name:"arrow",options:{stroke_color:["00","00","00"],dim:4,arrow:{h:5,w:10},headlen:10},init:function(t,o){this.canvas=t,this.ctx=o,this.ctx.strokeColor=this.options.stroke_color,this.ctx.fillStyle="rgba(0,0,0,0)",this.drawing=!1},start:function(t){this.canvas_coords=this.canvas.getBoundingClientRect();var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.startX=o,this.options.startY=i,this.options.endX=o,this.options.endY=i,this.ctx.beginPath(),this.drawing=!0},stroke:function(t){if(this.drawing){p.history.drawingState(this.canvas,this.ctx,p.history.undo_list);var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.endX=o,this.options.endY=i,this.drawTool()}},stop:function(t){this.drawing&&this.options.startX!==this.options.endX&&this.options.startY!==this.options.endY?(this.ctx.beginPath(),this.drawTool(),this.ctx.closePath(),this.ctx.stroke(),this.drawing=!1,p.history.setRawData(),p.history.saveState(this.canvas)):(this.ctx.closePath(),this.ctx.stroke(),this.drawing=!1)},drawTool:function(){this.ctx.beginPath(),p.history.setStyleElement(this.canvas,this.ctx);var t=Math.atan2(this.options.endY-this.options.startY,this.options.endX-this.options.startX);this.ctx.moveTo(this.options.startX,this.options.startY),this.ctx.lineTo(this.options.endX,this.options.endY),this.ctx.lineTo(this.options.endX-this.options.headlen*Math.cos(t-Math.PI/6),this.options.endY-this.options.headlen*Math.sin(t-Math.PI/6)),this.ctx.moveTo(this.options.endX,this.options.endY),this.ctx.lineTo(this.options.endX-this.options.headlen*Math.cos(t+Math.PI/6),this.options.endY-this.options.headlen*Math.sin(t+Math.PI/6)),this.ctx.stroke()}},p.line={name:"line",options:{stroke_color:["00","00","00"],dim:4},init:function(t,o){this.canvas=t,this.ctx=o,this.ctx.strokeColor=this.options.stroke_color,this.ctx.fillStyle="rgba(0,0,0,0)",this.drawing=!1},start:function(t){this.canvas_coords=this.canvas.getBoundingClientRect();var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.startX=o,this.options.startY=i,this.options.endX=o,this.options.endY=i,this.ctx.beginPath(),this.drawing=!0},stroke:function(t){if(this.drawing){p.history.drawingState(this.canvas,this.ctx,p.history.undo_list);var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.endX=o,this.options.endY=i,this.drawTool()}},stop:function(t){this.drawing&&this.options.startX!==this.options.endX&&this.options.startY!==this.options.endY?(this.ctx.beginPath(),this.drawTool(),this.ctx.closePath(),this.ctx.stroke(),this.drawing=!1,p.history.setRawData(),p.history.saveState(this.canvas)):(this.ctx.closePath(),this.ctx.stroke(),this.drawing=!1)},drawTool:function(){this.ctx.beginPath(),p.history.setStyleElement(this.canvas,this.ctx),this.ctx.moveTo(this.options.startX,this.options.startY),this.ctx.lineTo(this.options.endX,this.options.endY),this.ctx.stroke()},redrawTool:function(){this.ctx.beginPath(),p.history.setStyleElement(this.canvas,this.ctx),this.ctx.moveTo(this.options.startX,this.options.startY),this.ctx.lineTo(this.options.endX,this.options.endY),this.ctx.stroke()}},p.circle={name:"circle",options:{stroke_color:["00","00","00"],dim:4},init:function(t,o){this.canvas=t,this.ctx=o,this.ctx.strokeColor=this.options.stroke_color,this.ctx.fillStyle="rgba(0,0,0,0)",this.drawing=!1},start:function(t){this.canvas_coords=this.canvas.getBoundingClientRect();var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.startX=o,this.options.startY=i,this.options.endX=o,this.options.endY=i,this.ctx.beginPath(),this.drawing=!0},stroke:function(t){if(this.drawing){var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.endX=o,this.options.endY=i,p.history.drawingState(this.canvas,this.ctx,p.history.undo_list)}},stop:function(t){this.drawing&&this.options.startX!==this.options.endX&&this.options.startY!==this.options.endY?(this.drawTool(),this.ctx.closePath(),this.ctx.stroke(),this.drawing=!1,p.history.setRawData(),p.history.saveState(this.canvas)):(this.ctx.closePath(),this.ctx.stroke(),this.drawing=!1)},drawTool:function(){if(this.drawing){p.history.setStyleElement(this.canvas,this.ctx);var t=parseInt(this.options.endX-this.options.startX),o=parseInt(this.options.endY-this.options.startY),i=t+o,s=2*Math.PI/i;this.options.radius=i,this.ctx.beginPath();for(var n=0;n<2*Math.PI;n+=s){var e=t+i*Math.cos(n),a=o-i*Math.sin(n);this.ctx.lineTo(e+this.options.startX,a+this.options.startY)}this.ctx.stroke()}}},p.ellipse={name:"ellipse",options:{stroke_color:["00","00","00"],dim:4},init:function(t,o){this.canvas=t,this.ctx=o,this.ctx.strokeColor=this.options.stroke_color,this.ctx.fillStyle="rgba(0,0,0,0)",this.drawing=!1},start:function(t){this.canvas_coords=this.canvas.getBoundingClientRect();var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.startX=o,this.options.startY=i,this.options.endX=o,this.options.endY=i,this.ctx.beginPath(),this.drawing=!0},stroke:function(t){if(this.drawing){var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.endX=o,this.options.endY=i,p.history.drawingState(this.canvas,this.ctx,p.history.undo_list)}},stop:function(t){this.drawing&&this.options.startX!==this.options.endX&&this.options.startY!==this.options.endY?(this.drawTool(),this.ctx.closePath(),this.ctx.stroke(),this.drawing=!1,p.history.setRawData(),p.history.saveState(this.canvas)):(this.ctx.closePath(),this.ctx.stroke(),this.drawing=!1)},drawTool:function(){if(this.drawing){for(p.history.setStyleElement(this.canvas,this.ctx),this.ctx.beginPath(),a=0*Math.PI;a<2*Math.PI;a+=.01)r=Math.floor(this.options.startX-parseInt(this.options.endX-this.options.startX)*Math.cos(a)),h=Math.floor(this.options.startY+parseInt(this.options.endY-this.options.startY)*Math.sin(a)),0==a?this.ctx.moveTo(r,h):this.ctx.lineTo(r,h);this.ctx.stroke()}}},p.pencil={name:"pencil",options:{stroke_color:["00","00","00"],dim:4},init:function(t,o){this.canvas=t,this.ctx=o,this.ctx.strokeColor=this.options.fillStyle,this.drawing=!1},start:function(t){p.history.setStyleElement(this.canvas,this.ctx),this.canvas_coords=this.canvas.getBoundingClientRect();var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.startX=o,this.options.startY=i,this.options.endX=0,this.options.endY=0,this.ctx.beginPath(),this.ctx.moveTo(this.options.startX,this.options.startY),p.history.setRawData(),this.drawing=!0},stroke:function(t){if(this.drawing){var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.startX=o,this.options.startY=i,this.options.endX=0,this.options.endY=0,this.ctx.lineTo(this.options.startX,this.options.startY),p.history.setRawData(),this.ctx.stroke()}},stop:function(t){this.drawing&&(this.drawing=!1,p.history.saveState(this.canvas))},drawTool:function(){},redrawTool:function(){this.ctx.beginPath();for(var t=0;t<this.options.pencilData.length;t++)0==t?this.ctx.moveTo(this.options.pencilData[t].x+this.options.diffX,this.options.pencilData[t].y+this.options.diffY):this.ctx.lineTo(this.options.pencilData[t].x+this.options.diffX,this.options.pencilData[t].y+this.options.diffY);this.ctx.stroke()}},p.move={name:"move",options:{arrTool:["square","circle","text","image","line","arrow","ellipse"],prevTool:"",movedObject:-1,cursorStyle:"move",isResize:!1,arrResize:{startX:!1,startY:!1,endX:!1,endY:!1},resizeMargin:10},init:function(t,o){this.canvas=t,this.canvas_coords=this.canvas.getBoundingClientRect(),this.ctx=o,this.drawing=!1},start:function(t){var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;return this.options.startX=o,this.options.startY=i,this.options.startDiffX=t.pageX,this.options.startDiffY=t.pageY,this.options.cursorStyle="move",this.hitTest(),this.options.movedObject>-1&&(this.options.selectedObject=this.options.movedObject,p.history.redrawState()),!(this.options.movedObject>=0)||(this.options.prevTool=p.event.options.activeTool,p.event.options.activeTool=p.move,p.options.toolsObj.canvas.style.cursor=this.options.cursorStyle,void(this.drawing=!0))},stroke:function(t){if(this.drawing){var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.endX=o,this.options.endY=i,this.options.endDiffX=t.pageX,this.options.endDiffY=t.pageY,this.options.diffX=this.options.endDiffX-this.options.startDiffX,this.options.diffY=this.options.endDiffY-this.options.startDiffY,p.history.redrawState(this.canvas,this.ctx)}},stop:function(o){if(this.drawing){if(this.drawing=!1,this.options.movedObject>=0&&(this.options.startX-this.options.endX!==0||this.options.startY-this.options.endY!==0)&&void 0!=this.options.endX)if(p.history.tmp_raw_undo_list=t.copy(p.history.raw_undo_list[p.history.options.activePage]),this.options.arrTool.indexOf(p.history.options.arrData.name)>-1){if(this.options.isResize===!1?(p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].startX[0]=p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].startX[0]+this.options.diffX,p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].startY[0]=p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].startY[0]+this.options.diffY,p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].endX[0]=p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].endX[0]+this.options.diffX,p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].endY[0]=p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].endY[0]+this.options.diffY):(this.options.arrResize.startX===!0&&(p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].startX[0]=p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].startX[0]+this.options.diffX),this.options.arrResize.startY===!0&&(p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].startY[0]=p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].startY[0]+this.options.diffY),this.options.arrResize.endX===!0&&(p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].endX[0]=p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].endX[0]+this.options.diffX),this.options.arrResize.endY===!0&&(p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].endY[0]=p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].endY[0]+this.options.diffY)),"text"==p.history.options.arrData.name){for(var i=0;i<p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].finalTextInfo.length;i++)p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].finalTextInfo[i].x=p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].finalTextInfo[i].x+this.options.diffX,p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].finalTextInfo[i].y=p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].finalTextInfo[i].y+this.options.diffY;p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].textInfo.x+=this.options.diffX,p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].textInfo.y+=this.options.diffY;
}}else for(var i=0;i<p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].pencilData.length;i++)p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].pencilData[i].x=p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].pencilData[i].x+this.options.diffX,p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].pencilData[i].y=p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].pencilData[i].y+this.options.diffY;p.options.optionArrData=p.history.options.arrData={startX:[],startY:[],endX:[],endY:[],pencilData:[]},p.history.saveState(this.canvas),this.options.movedObject=-1,this.options.cursorStyle="default",p.options.toolsObj.canvas.style.cursor=this.options.cursorStyle,this.options.arrResize={startX:!1,startY:!1,endX:!1,endY:!1},this.options.isResize=!1,""!=this.options.prevTool&&(p.event.options.activeTool=this.options.prevTool,this.options.prevTool="")}},drawTool:function(){if(this.ctx.beginPath(),this.drawing){var t=p.history.options.arrData.name;"square"===t&&(p.square.init(this.canvas,this.ctx),p.square.options.startX=p.history.options.arrData.startX[0]+this.options.diffX,p.square.options.startY=p.history.options.arrData.startY[0]+this.options.diffY,p.square.options.endX=p.history.options.arrData.endX[0]+this.options.diffX,p.square.options.endY=p.history.options.arrData.endY[0]+this.options.diffY,p.square.drawTool())}this.ctx.stroke()},redrawTool:function(){var t=p.history.raw_undo_list[p.history.options.activePage],o=t.length-1;if(o>=0){for(e=0;e<=o;e++){if(this.ctx.beginPath(),this.options.selectedObject==e?(this.options.isSelectedObj=!0,this.ctx.setLineDash([0,0])):(this.options.isSelectedObj=!1,this.ctx.setLineDash([0,0])),p.history.options.font_size=t[e].font_size,p.history.options.fillStyle=t[e].fillStyle,p.history.options.lineWidth=t[e].lineWidth,p.history.setStyleElement(this.canvas,this.ctx),this.options.arrTool.indexOf(t[e].name)>-1){if("square"===t[e].name&&(this.options.currentDrawTool=p.square),"circle"===t[e].name&&(this.options.currentDrawTool=p.circle),"image"===t[e].name){this.options.currentDrawTool=p.image,this.options.currentDrawTool.options.img=t[e].imageURL;var i=new Image;i.onload=function(t){},i.src=this.options.currentDrawTool.options.img,this.options.currentDrawTool.options.img=i}if("line"===t[e].name&&(this.options.currentDrawTool=p.line),"arrow"===t[e].name&&(this.options.currentDrawTool=p.arrow),"ellipse"===t[e].name&&(this.options.currentDrawTool=p.ellipse),"text"===t[e].name&&(this.options.currentDrawTool=p.text),this.options.currentDrawTool.init(p.options.canvas,p.options.ctx),this.options.currentDrawTool.drawing=!0,this.options.movedObject==e&&this.options.isResize===!0?(this.options.arrResize.startX===!0?this.options.currentDrawTool.options.startX=p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].startX[0]+this.options.diffX:this.options.currentDrawTool.options.startX=p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].startX[0],this.options.arrResize.startY===!0?this.options.currentDrawTool.options.startY=p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].startY[0]+this.options.diffY:this.options.currentDrawTool.options.startY=p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].startY[0],this.options.arrResize.endX===!0?this.options.currentDrawTool.options.endX=p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].endX[0]+this.options.diffX:this.options.currentDrawTool.options.endX=p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].endX[0],this.options.arrResize.endY===!0?this.options.currentDrawTool.options.endY=p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].endY[0]+this.options.diffY:this.options.currentDrawTool.options.endY=p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].endY[0]):this.options.movedObject==e?(this.options.currentDrawTool.options.startX=p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].startX[0]+this.options.diffX,this.options.currentDrawTool.options.startY=p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].startY[0]+this.options.diffY,this.options.currentDrawTool.options.endX=p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].endX[0]+this.options.diffX,this.options.currentDrawTool.options.endY=p.history.raw_undo_list[p.history.options.activePage][this.options.movedObject].endY[0]+this.options.diffY):(this.options.currentDrawTool.options.startX=t[e].startX[0],this.options.currentDrawTool.options.startY=t[e].startY[0],this.options.currentDrawTool.options.endX=t[e].endX[0],this.options.currentDrawTool.options.endY=t[e].endY[0]),"text"===t[e].name){var s=0,n=0;this.options.movedObject===e&&(s=this.options.diffX,n=this.options.diffY),this.options.currentDrawTool.canvas=this.canvas,this.options.currentDrawTool.ctx=this.ctx,this.options.currentDrawTool.redrawTool(t[e].finalTextInfo,s,n)}else this.options.currentDrawTool.drawTool();this.options.currentDrawTool.drawing=!1}else"pencil"===t[e].name&&(this.options.currentDrawTool=p.pencil,this.options.currentDrawTool.options.pencilData=t[e].pencilData,this.options.movedObject==e?(this.options.currentDrawTool.options.diffX=this.options.endX-this.options.startX,this.options.currentDrawTool.options.diffY=this.options.endY-this.options.startY):(this.options.currentDrawTool.options.diffX=0,this.options.currentDrawTool.options.diffY=0)),this.options.currentDrawTool&&(this.options.currentDrawTool.drawing=!0,"pencil"===t[e].name?this.options.currentDrawTool.redrawTool():this.options.currentDrawTool.drawTool(),this.options.currentDrawTool.drawing=!1);this.ctx.stroke()}var a=this.canvas.toDataURL();p.event.options.isSave?p.history.final_canvas_url[p.history.options.activePage]=a:p.history.undo_list[p.history.options.activePage][0]=a,p.history.resetStyleElement()}},resizeCheck:function(t,o,i,s){this.options.startX>=t&&this.options.startX<=t+this.options.resizeMargin&&this.options.startY>=o&&this.options.startY<=o+this.options.resizeMargin?(this.options.arrResize.startX=!0,this.options.arrResize.startY=!0,this.options.arrResize.endX=!1,this.options.arrResize.endY=!1,this.options.cursorStyle="nwse-resize",this.options.isResize=!0):this.options.startX<=i&&this.options.startX>=i-this.options.resizeMargin&&this.options.startY<=s&&this.options.startY>=s-this.options.resizeMargin?(this.options.arrResize.startX=!1,this.options.arrResize.startY=!1,this.options.arrResize.endX=!0,this.options.arrResize.endY=!0,this.options.cursorStyle="nwse-resize",this.options.isResize=!0):this.options.startX>=t&&this.options.startX<=t+this.options.resizeMargin&&this.options.startY<=s&&this.options.startY>=s-this.options.resizeMargin?(this.options.arrResize.startX=!0,this.options.arrResize.startY=!1,this.options.arrResize.endX=!1,this.options.arrResize.endY=!0,this.options.cursorStyle="nesw-resize",this.options.isResize=!0):this.options.startX<=i&&this.options.startX>=i-this.options.resizeMargin&&this.options.startY>=o&&this.options.startY<=o+this.options.resizeMargin?(this.options.arrResize.startX=!1,this.options.arrResize.startY=!0,this.options.arrResize.endX=!0,this.options.arrResize.endY=!1,this.options.cursorStyle="nesw-resize",this.options.isResize=!0):this.options.startX>=t&&this.options.startX<=t+this.options.resizeMargin?(this.options.arrResize.startX=!0,this.options.arrResize.startY=!1,this.options.arrResize.endX=!1,this.options.arrResize.endY=!1,this.options.cursorStyle="ew-resize",this.options.isResize=!0):this.options.startX<=i&&this.options.startX>=i-this.options.resizeMargin?(this.options.arrResize.startX=!1,this.options.arrResize.startY=!1,this.options.arrResize.endX=!0,this.options.arrResize.endY=!1,this.options.cursorStyle="ew-resize",this.options.isResize=!0):this.options.startY>=o&&this.options.startY<=o+this.options.resizeMargin?(this.options.arrResize.startX=!1,this.options.arrResize.startY=!0,this.options.arrResize.endX=!1,this.options.arrResize.endY=!1,this.options.cursorStyle="ns-resize",this.options.isResize=!0):this.options.startY<=s&&this.options.startY>=s-this.options.resizeMargin&&(this.options.arrResize.startX=!1,this.options.arrResize.startY=!1,this.options.arrResize.endX=!1,this.options.arrResize.endY=!0,this.options.cursorStyle="ns-resize",this.options.isResize=!0)},hitTest:function(){var t=p.history.raw_undo_list[p.history.options.activePage],o=t.length-1;for(this.options.movedObject=-1,e=o;e>=0&&!(this.options.movedObject>-1);e--){if(p.history.options.arrData=t[e],"square"===p.history.options.arrData.name&&this.options.startX>=p.history.options.arrData.startX[0]&&this.options.startX<=p.history.options.arrData.endX[0]&&this.options.startY>=p.history.options.arrData.startY[0]&&this.options.startY<=p.history.options.arrData.endY[0]){this.options.movedObject=e;break}if("image"===p.history.options.arrData.name&&this.options.startX>=p.history.options.arrData.startX[0]&&this.options.startX<=p.history.options.arrData.endX[0]&&this.options.startY>=p.history.options.arrData.startY[0]&&this.options.startY<=p.history.options.arrData.endY[0]){this.options.movedObject=e,this.resizeCheck(p.history.options.arrData.startX[0],p.history.options.arrData.startY[0],p.history.options.arrData.endX[0],p.history.options.arrData.endY[0]);break}if("text"===p.history.options.arrData.name&&this.options.startX>=p.history.options.arrData.startX[0]&&this.options.startX<=p.history.options.arrData.endX[0]&&this.options.startY>=p.history.options.arrData.startY[0]&&this.options.startY<=p.history.options.arrData.endY[0]){this.options.movedObject=e;break}if("pencil"===p.history.options.arrData.name&&p.history.options.arrData.pencilData.length>0)for(d=0;d<p.history.options.arrData.pencilData.length;d++)if(parseInt(p.history.options.arrData.pencilData[d].x-4)<=this.options.startX&&parseInt(p.history.options.arrData.pencilData[d].x+4)>=this.options.startX&&parseInt(p.history.options.arrData.pencilData[d].y-4)<=this.options.startY&&parseInt(p.history.options.arrData.pencilData[d].y+4)>=this.options.startY){this.options.movedObject=e;break}if("circle"===p.history.options.arrData.name){var i=t[e].radius,s=t[e].startX[0]-this.options.startX,n=t[e].startY[0]-this.options.startY;if(parseInt(s*s+n*n)<parseInt(i*i)){this.options.movedObject=e;break}}if("ellipse"===p.history.options.arrData.name){var a=0,c=1e8,l=0;this.options.startX=Math.floor(this.options.startX);for(var d=0*Math.PI;d<2*Math.PI;d+=.01)r=Math.floor(p.history.options.arrData.startX[0]-parseInt(p.history.options.arrData.endX[0]-p.history.options.arrData.startX[0])*Math.cos(d)),h=Math.floor(p.history.options.arrData.startY[0]+parseInt(p.history.options.arrData.endY[0]-p.history.options.arrData.startY[0])*Math.sin(d)),this.options.startX>=r-5&&this.options.startX<=r+5&&(this.options.startX==r&&(l=r),c>h&&(c=h),a<h&&(a=h));if(this.options.startX==l&&this.options.startY>c&&this.options.startY<a){this.options.movedObject=e;break}}if("line"===p.history.options.arrData.name){if(p.history.options.arrData.endX[0]<p.history.options.arrData.startX[0])var v=p.history.options.arrData.endX[0],g=p.history.options.arrData.startX[0];else var v=p.history.options.arrData.startX[0],g=p.history.options.arrData.endX[0];if(p.history.options.arrData.endY[0]<p.history.options.arrData.startY[0])var u=p.history.options.arrData.endY[0],y=p.history.options.arrData.startY[0];else var u=p.history.options.arrData.startY[0],y=p.history.options.arrData.endY[0];if(this.options.startX>=v&&this.options.startX<=g&&this.options.startY>=u&&this.options.startY<=y){var f=Math.atan2(this.options.startY-p.history.options.arrData.startY[0],this.options.startX-p.history.options.arrData.startX[0]),_=Math.abs(f)-Math.abs(p.history.options.arrData.lineAngle);if(Math.abs(_)<.2){this.options.movedObject=e;break}}}if("arrow"===p.history.options.arrData.name){if(p.history.options.arrData.endX[0]<p.history.options.arrData.startX[0])var v=p.history.options.arrData.endX[0],g=p.history.options.arrData.startX[0];else var v=p.history.options.arrData.startX[0],g=p.history.options.arrData.endX[0];if(p.history.options.arrData.endY[0]<p.history.options.arrData.startY[0])var u=p.history.options.arrData.endY[0],y=p.history.options.arrData.startY[0];else var u=p.history.options.arrData.startY[0],y=p.history.options.arrData.endY[0];if(this.options.startX>=v&&this.options.startX<=g&&this.options.startY>=u&&this.options.startY<=y){var f=Math.atan2(this.options.startY-p.history.options.arrData.startY[0],this.options.startX-p.history.options.arrData.startX[0]),_=Math.abs(f)-Math.abs(p.history.options.arrData.arrowAngle);if(Math.abs(_)<.2){this.options.movedObject=e;break}}}}}},p.square={name:"square",options:{stroke_color:["00","00","00"],dim:4},init:function(t,o){this.canvas=t,this.ctx=o,this.drawing=!1},start:function(t){this.canvas_coords=this.canvas.getBoundingClientRect();var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.startX=o,this.options.startY=i,this.options.endX=o,this.options.endY=i,this.ctx.beginPath(),this.drawing=!0},stroke:function(t){if(this.drawing){p.history.drawingState(this.canvas,this.ctx,p.history.undo_list),this.ctx.beginPath();var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.endX=o,this.options.endY=i,this.drawTool()}},stop:function(t){this.drawing&&this.options.startX!==this.options.endX&&this.options.startY!==this.options.endY?(this.ctx.beginPath(),this.options.width=this.options.endX-this.options.startX,this.options.height=this.options.endY-this.options.startY,this.drawTool(),this.ctx.stroke(),this.drawing=!1,p.history.setRawData(),p.history.saveState(this.canvas)):(this.ctx.closePath(),this.ctx.stroke(),this.drawing=!1)},drawLine:function(t,o){p.history.setStyleElement(this.canvas,this.ctx),this.ctx.moveTo(t.x,t.y),this.ctx.lineTo(o.x,o.y),this.ctx.stroke()},drawTool:function(){p.move.options.isSelectedObj&&1==p.move.options.isSelectedObj?this.ctx.setLineDash([0,0]):this.ctx.setLineDash([0,0]),o={x:this.options.startX,y:this.options.startY,r:0},i={x:this.options.startX,y:this.options.endY,r:0},s={x:this.options.endX,y:this.options.endY,r:0},n={x:this.options.endX,y:this.options.startY,r:0},this.drawLine(o,i),this.drawLine(i,s),this.drawLine(s,n),this.drawLine(n,o)}},p.renderPage=function(t){var o=t.getViewport(p.options.pdfOptions.scale),i=document.createElement("canvas"),s=i.getContext("2d"),n={canvasContext:s,viewport:o};i.setAttribute("id","page"+t.pageIndex),i.height=o.height,i.width=o.width,p.history.options.canvas_width=i.width,p.history.options.canvas_height=i.height,p.options.toolsObj.canvasContainer.appendChild(i);var e=t.render(n);$(document).ready(function(){e.promise.then(function(){p.options.bindCnt++,""===p.options.bindFlag&&t.transport.numPages==p.options.bindCnt&&(p.history.options.pdfobj=t,p.bindEvent(0),p.options.bindFlag=1)})})},p.bindEvent=function(t){if(""==p.options.bindFlag){if(p.options.bindFlag="true",p.history.options.PrevPage=t,p.history.options.activePage=t,p.options.canvas=p.options.toolsObj.canvas,p.options.ctx=p.options.canvas.getContext("2d"),p.history.initial_canvas_url.hasOwnProperty(t))p.options.imgURL=p.history.final_canvas_url[p.history.options.activePage];else{var o=document.getElementById("page"+t);p.history.initial_canvas_url[t]=o.toDataURL(),p.history.undo_list[t]=[o.toDataURL()],p.history.final_canvas_url[p.history.options.activePage]=p.history.initial_canvas_url[p.history.options.activePage],p.options.imgURL=p.history.initial_canvas_url[p.history.options.activePage]}p.options.canvas.height=p.history.options.canvas_height,p.options.canvas.width=p.history.options.canvas_width;var i=document.createElement("img");i.src=p.options.imgURL,i.onload=function(){p.options.canvas_coords=p.options.canvas.getBoundingClientRect(),p.history.options.canvas_coords=p.options.canvas_coords,p.options.ctx.clearRect(0,0,p.options.canvas.width,p.options.canvas.height),p.options.ctx.drawImage(i,0,0,p.options.canvas.width,p.options.canvas.height),p.options.toolsObj.loading.textContent="",p.history.saveState(p.options.canvas),p.options.btnFlag===!1&&(p.options.btnFlag=!0,p.options.toolsObj.pencil.addEventListener("click",function(){p.event.options.activeTool=p.pencil,p.history.manageActiveBtn("pencil"),p.pencil.init(p.options.canvas,p.options.ctx)}),p.options.toolsObj.square.addEventListener("click",function(){p.event.options.activeTool=p.square,p.history.manageActiveBtn("square"),p.square.init(p.options.canvas,p.options.ctx)}),p.options.toolsObj.circle.addEventListener("click",function(){p.event.options.activeTool=p.circle,p.history.manageActiveBtn("circle"),p.circle.init(p.options.canvas,p.options.ctx)}),p.options.toolsObj.ellipse.addEventListener("click",function(){p.event.options.activeTool=p.ellipse,p.history.manageActiveBtn("ellipse"),p.ellipse.init(p.options.canvas,p.options.ctx)}),p.options.toolsObj.text.addEventListener("click",function(){p.event.options.activeTool=p.text,p.history.manageActiveBtn("text"),p.text.init(p.options.canvas,p.options.ctx)}),p.options.toolsObj.contenteditor.addEventListener("blur",function(){p.options.toolsObj.editor_wrapper.style.display="none",p.text.drawTool()}),p.options.toolsObj.arrow.addEventListener("click",function(){p.event.options.activeTool=p.arrow,p.history.manageActiveBtn("arrow"),p.arrow.init(p.options.canvas,p.options.ctx)}),p.options.toolsObj.line.addEventListener("click",function(){p.event.options.activeTool=p.line,p.history.manageActiveBtn("line"),p.line.init(p.options.canvas,p.options.ctx)}),p.options.toolsObj.imageupload.addEventListener("change",function(){p.image.uploadImage(this.files[0]),p.event.options.activeTool=p.image,p.history.manageActiveBtn("clear_image"),p.image.init(p.options.canvas,p.options.ctx)}),p.options.toolsObj.clear_image.addEventListener("click",function(){p.image.resetImage(),p.options.toolsObj.frm_canvas_tool.reset()}),p.options.toolsObj.undo.addEventListener("click",function(){p.history.undo(p.options.canvas,p.options.ctx)}),p.options.toolsObj.redo.addEventListener("click",function(){p.history.redo(p.options.canvas,p.options.ctx)}),p.options.toolsObj.save.addEventListener("click",function(){p.event.options.activeTool="",p.history.manageActiveBtn(""),p.event.savepdf("saveandclose")}),p.options.toolsObj.apply.addEventListener("click",function(){p.event.options.activeTool="",p.history.manageActiveBtn(""),p.event.savepdf("apply")}),p.options.toolsObj.fontsize.addEventListener("change",function(){p.history.options.font_size=this.value}),p.options.toolsObj.fillstyle.addEventListener("change",function(){p.history.options.fillStyle="#"+this.value}),p.options.toolsObj.linewidth.addEventListener("change",function(){p.history.options.lineWidth=this.value}),p.options.toolsObj.prevBtn.addEventListener("click",function(){p.options.toolsObj.prevBtn.getAttribute("disable")||(p.options.bindFlag="",p.bindEvent(parseInt(p.history.options.activePage-1)))}),p.options.toolsObj.nextBtn.addEventListener("click",function(){p.options.toolsObj.nextBtn.getAttribute("disabled")||(p.options.bindFlag="",p.bindEvent(parseInt(p.history.options.activePage+1)))}),document.addEventListener("keydown",function(t){p.options.toolsObj.canvas&&8==t.keyCode&&p.event.removeObject()},!1),p.options.toolsObj.fontsize.value=p.history.options.font_size,p.options.toolsObj.fillstyle.value=p.history.options.fillStyle,p.options.toolsObj.linewidth.value=p.history.options.lineWidth),p.event.init(p.options.canvas,p.options.ctx),p.history.setButtonStyle(),p.options.actionListObj.length>0&&(p.move.init(p.options.canvas,p.options.ctx),p.move.redrawTool())}}},p.renderPages=function(t){p.history.options.numPages=t.numPages;for(var o=1;o<=t.numPages;o++)t.getPage(o).then(p.renderPage)},p.renderPDF=function(t,o,i){this.options.pdfOptions=i||{scale:2},p.options.toolsObj.loading.textContent="Wait while loading PDF file...",p.history.raw_undo_list=p.options.actionListObj,PDFJS.disableWorker=!1,PDFJS.workerSrc=p.options.pdfWorker,PDFJS.getDocument(t).then(p.renderPages)},p}),o.directive("pdfAnnotation",["pdfAnnotationFactory",function(o){return{restrict:"E",scope:{options:"=",callbackFn:"&",closeFn:"&",saveAttachment:"&"},transclude:!0,template:'<div id="controllers"><span class="controller btn btn-icn" id="pencil" title="Freehand Drawing"></span><span class="controller btn btn-icn" id="square" title="Square"></span><span class="controller btn btn-icn hide" id="circle" title="Circle"></span><span class="controller btn btn-icn" id="ellipse" title="Ellipse"></span><span class="controller btn btn-icn" id="text" title="Text"></span><span class="controller btn btn-icn" id="arrow" title="Arrow"></span><span class="controller btn btn-icn" id="line" title="Line"></span><span class="controller btn btn-icn" id="undo" title="Undo"></span><span class="controller btn btn-icn" id="redo" title="Redo"></span><span class="controller title" id="activePage" disabled="disabled"></span>&nbsp; out of&nbsp;<span class="controller title" id="totalPage" disabled="disabled"></span><span class="controller btn" id="prevBtn"><</span> &nbsp;<input type="text" class="pagenumber" name="currentPage" id="currentPage" />&nbsp;<span class="controller btn" id="nextBtn">></span><a href="#" id="close" title="Cancel" class="controller btn  btnRight">&nbsp;Cancel</a><span class="controller btn  btnRight" id="savecsf" title="Save & Close">Save & Close</span><span class="controller btn  btnRight" id="applycsf" title="Apply">Apply</span><br /><br /><form id="frm_canvas_tool"><input name="imageupload" id="imageupload" class="input_file" type="file" accept="image/*" ><span class="controller btn hide" id="clear_image">Clear Image</span></form>    Font Size:<select id="fontsize" name="fontsize"><option value="">Select Font Size</option><option value="2">2px</option><option value="5">5px</option><option value="7">7px</option><option value="8">8px</option><option value="9">9px</option><option value="10">10px</option><option value="11">11px</option><option value="12">12px</option><option value="13">13px</option><option value="14">14px</option><option value="16">16px</option><option value="18">18px</option><option value="32">32px</option></select>    Color:<select id="fillstyle" name="fillstyle"><option>Select Color</option><option value="FF0000">Red</option><option value="00FF00">Green</option><option value="0000FF">Blue</option><option value="000000">Black</option><option value="FFFFFF">White</option></select>    Line Width:<select id="linewidth" name="linewidth"><option value="">Select Font Size</option><option value="2">2px</option><option value="5">5px</option><option value="7">7px</option><option value="8">8px</option></select><span class="controller" id="loading"></span></div><div id="canvas-container" class="canvas-container" style="visibility: hidden; height: 0px;"></div><div id="canvas-cont" class="canvas-container"><canvas id="canvas"></canvas><div id="editor_wrapper" style="display:none;"><textarea id="contenteditor"  onkeyup="textAreaAdjust(this)" style="overflow:hidden"></textarea></div></div><div ng-if="errorURL"><h1>URL not found!</h1></div>',link:function(i,s,n,e){o.options.closeFn=i.closeFn,o.options.callbackFn=i.callbackFn,o.options.toolsObj.loading=t.element(document.querySelector("#loading"))[0],o.options.toolsObj.pencil=t.element(document.querySelector("#pencil"))[0],o.options.toolsObj.square=t.element(document.querySelector("#square"))[0],o.options.toolsObj.circle=t.element(document.querySelector("#circle"))[0],o.options.toolsObj.ellipse=t.element(document.querySelector("#ellipse"))[0],o.options.toolsObj.text=t.element(document.querySelector("#text"))[0],o.options.toolsObj.contenteditor=t.element(document.querySelector("#contenteditor"))[0],o.options.toolsObj.editor_wrapper=t.element(document.querySelector("#editor_wrapper"))[0],o.options.toolsObj.arrow=t.element(document.querySelector("#arrow"))[0],o.options.toolsObj.line=t.element(document.querySelector("#line"))[0],o.options.toolsObj.imageupload=t.element(document.querySelector("#imageupload"))[0],o.options.toolsObj.clear_image=t.element(document.querySelector("#clear_image"))[0],o.options.toolsObj.frm_canvas_tool=t.element(document.querySelector("#frm_canvas_tool"))[0],o.options.toolsObj.undo=t.element(document.querySelector("#undo"))[0],o.options.toolsObj.redo=t.element(document.querySelector("#redo"))[0],o.options.toolsObj.save=t.element(document.querySelector("#savecsf"))[0],o.options.toolsObj.fontsize=t.element(document.querySelector("#fontsize"))[0],o.options.toolsObj.fillstyle=t.element(document.querySelector("#fillstyle"))[0],o.options.toolsObj.linewidth=t.element(document.querySelector("#linewidth"))[0],o.options.toolsObj.prevBtn=t.element(document.querySelector("#prevBtn"))[0],o.options.toolsObj.nextBtn=t.element(document.querySelector("#nextBtn"))[0],o.options.toolsObj.activePage=t.element(document.querySelector("#activePage"))[0],o.options.toolsObj.currentPage=t.element(document.querySelector("#currentPage"))[0],o.options.toolsObj.totalPage=t.element(document.querySelector("#totalPage"))[0],o.options.toolsObj.canvas=t.element(document.querySelector("#canvas"))[0],o.options.toolsObj.close=t.element(document.querySelector("#close"))[0],o.options.toolsObj.apply=t.element(document.querySelector("#applycsf"))[0],o.options.saveAttachment=i.saveAttachment,o.options.toolsObj.canvasContainer=t.element(document.querySelector("#canvas-container"))[0],o.options.toolsObj.close.addEventListener("click",function(){o.event.options.activeTool="",o.history.manageActiveBtn(""),o.event.closepdf()}),i.$watch("options",function(t,s){""!==i.options.url?(o.options.actionListObj=[],o.history.initial_canvas_url=[],o.history.final_canvas_url=[],o.history.final_canvas_url=[],o.history.redo_list=[],o.history.undo_list=[],o.history.raw_undo_list=[],o.history.raw_redo_list=[],o.history.raw_undo_ver_list=[],o.history.raw_redo_ver_list=[],o.history.tmp_raw_undo_list="",o.history.options.activePage=0,o.history.manageActiveBtn(""),o.history.setButtonStyle(),o.options.toolsObj.canvasContainer.innerHTML="",o.text.options.finalTextInfo=[],o.options.bindFlag="",o.options.btnFlag=!1,o.options.bindCnt=0,o.move.options.isSelectedObj=!1,o.move.options.selectedObject=-1,i.options.pdfworker&&(o.options.pdfWorker=i.options.pdfworker),i.options.actionListObj&&(o.options.actionListObj=i.options.actionListObj),i.errorURL=!1,o.renderPDF(i.options.url,o.options.toolsObj.canvasContainer)):i.errorURL=!0})}}}])}),$(window).scroll(function(){var t=90,o=$(window).scrollTop();o>t?$("#controllers").css({position:"relative"}):$("#controllers").css({position:"relative"})});