"use strict";!function(t,o){return"function"==typeof define&&define.amd?void define("pdf-annotation",["angular"],function(t){return o(t)}):o(t)}("undefined"==typeof angular?null:angular,function(t){var o=t.module("pdfAnnotation",[]);o.factory("pdfAnnotationFactory",function(){var o,i,s,n,e,a,r={};return r.options={viewport:"",canvas_rand:"",ctx_rand:"",renderContext:{canvasContext:"",viewport:""},bindFlag:"",btnFlag:!1,bindCnt:0,pdfOptions:{},toolsObj:{},optionArrData:{startX:[],startY:[],endX:[],endY:[],pencilData:[]},pdfWorker:"src/js/pdf.worker.js"},r.history={options:{canvas_width:"",canvas_height:"",activePage:0,totalPage:1,enablePrevBtn:!1,enableNextBtn:!1,font_size:18,fillStyle:"FF0000",lineWidth:2,undoFlag:!1,redoFlag:!1,arrData:{startX:[],startY:[],endX:[],endY:[],pencilData:[]}},initial_canvas_url:[],final_canvas_url:[],redo_list:[],undo_list:[],raw_undo_list:[],raw_redo_list:[],raw_undo_ver_list:[],raw_redo_ver_list:[],tmp_raw_undo_list:"",setStyleElement:function(t,o){o.fillStyle="#"+this.options.fillStyle.replace("#",""),o.font=this.options.font_size+"px Calibri",o.lineWidth=this.options.lineWidth,o.strokeStyle="#"+this.options.fillStyle.replace("#","")},resetStyleElement:function(){this.options.fillStyle=document.getElementById("fillstyle").value,this.options.font_size=document.getElementById("fontsize").value,this.options.lineWidth=document.getElementById("linewidth").value},setButtonStyle:function(){this.raw_undo_ver_list.length>0?(this.raw_undo_ver_list[this.options.activePage].length>0||this.raw_undo_list[this.options.activePage].length>0?r.options.toolsObj.undo.classList.remove("cur_disable"):r.options.toolsObj.undo.className+=" cur_disable",this.raw_redo_ver_list[this.options.activePage].length>0?r.options.toolsObj.redo.classList.remove("cur_disable"):r.options.toolsObj.redo.className+=" cur_disable"):(r.options.toolsObj.undo.className+=" cur_disable",r.options.toolsObj.redo.className+=" cur_disable")},saveState:function(o,i,s){s=s||!1,s||(this.redo_list=[]),this.undo_list.hasOwnProperty(this.options.activePage)||(this.undo_list[this.options.activePage]=[]),this.raw_undo_list.hasOwnProperty(this.options.activePage)||(this.raw_undo_list[this.options.activePage]=[],this.raw_redo_list[this.options.activePage]=[],this.raw_undo_ver_list[this.options.activePage]=[],this.raw_redo_ver_list[this.options.activePage]=[]);var n=o.toDataURL();if(i)i.hasOwnProperty(this.options.activePage)||(i[this.options.activePage]=[]),i[this.options.activePage][0]=n;else if(this.undo_list[this.options.activePage][0]=n,r.event.options.activeTool&&"move"!==r.event.options.activeTool.name)this.saveRawData();else if(""!=this.tmp_raw_undo_list){var e=t.copy(this.tmp_raw_undo_list);this.tmp_raw_undo_list="",this.raw_undo_ver_list[this.options.activePage].push(e)}this.setButtonStyle(),r.history.final_canvas_url[r.history.options.PrevPage]=n},saveRawData:function(){if(!r.event.options.activeTool.drawing){if(this.raw_undo_list.hasOwnProperty(this.options.activePage)||(this.raw_undo_list[this.options.activePage]=[],this.raw_redo_list[this.options.activePage]=[],this.raw_undo_ver_list[this.options.activePage]=[],this.raw_redo_ver_list[this.options.activePage]=[]),this.raw_undo_list[this.options.activePage].length>0){var o=t.copy(this.raw_undo_list[this.options.activePage]);this.raw_undo_ver_list[this.options.activePage].push(o)}var i=t.copy(this.options.arrData);i.name&&""!=i.name&&(this.raw_undo_list[this.options.activePage][this.raw_undo_list[this.options.activePage].length]=i,this.options.undoFlag=!0),r.options.optionArrData=this.options.arrData={startX:[],startY:[],endX:[],endY:[],pencilData:[]}}},setRawData:function(){r.options.optionArrData.name=r.event.options.activeTool.name,r.options.optionArrData.startX.push(r.event.options.activeTool.options.startX),r.options.optionArrData.startY.push(r.event.options.activeTool.options.startY),r.options.optionArrData.endX.push(r.event.options.activeTool.options.endX),r.options.optionArrData.endY.push(r.event.options.activeTool.options.endY),r.options.optionArrData.font_size=this.options.font_size,r.options.optionArrData.fillStyle=this.options.fillStyle,r.options.optionArrData.lineWidth=this.options.lineWidth,"text"===r.options.optionArrData.name&&(r.options.optionArrData.textInfo=r.event.options.activeTool.options.textInfo,r.options.optionArrData.finalTextInfo=r.event.options.activeTool.options.finalTextInfo),"image"===r.options.optionArrData.name&&(r.options.optionArrData.imageURL=r.event.options.activeTool.options.uploadedImage[r.event.options.activeTool.options.uploadedImage.length-1]),"circle"===r.options.optionArrData.name&&(r.options.optionArrData.radius=r.event.options.activeTool.options.radius),"pencil"===r.options.optionArrData.name&&r.options.optionArrData.pencilData.push({x:r.event.options.activeTool.options.startX,y:r.event.options.activeTool.options.startY}),"line"===r.options.optionArrData.name&&(r.options.optionArrData.lineAngle=Math.atan2(r.event.options.activeTool.options.endY-r.event.options.activeTool.options.startY,r.event.options.activeTool.options.endX-r.event.options.activeTool.options.startX)),"arrow"===r.options.optionArrData.name&&(r.options.optionArrData.arrowAngle=Math.atan2(r.event.options.activeTool.options.endY-r.event.options.activeTool.options.startY,r.event.options.activeTool.options.endX-r.event.options.activeTool.options.startX)),this.options.arrData=t.copy(r.options.optionArrData)},undo:function(t,o){this.options.action="undo",this.restoreStateRawData(this.raw_undo_list,this.raw_redo_list),this.redrawState(t,o)},redo:function(t,o){this.options.action="redo",this.restoreStateRawData(this.raw_undo_list,this.raw_redo_list),r.move.init(t,o),this.redrawState(t,o)},restoreState:function(t,o,i,s){var n=i[this.options.activePage];if(n.length){if(s&&"undo"==this.options.action&&this.saveState(t,s,!0),"undo"==this.options.action){var e=n.pop();if(n.length)var a=n[n.length-1];else var a=e}else{var e=n.pop(),a=e;this.undo_list[this.options.activePage].push(e)}var h=document.createElement("img");h.src=a,h.onload=function(){o.clearRect(0,0,r.history.options.canvas_width,r.history.options.canvas_height),o.drawImage(h,0,0,r.history.options.canvas_width,r.history.options.canvas_height)}}},restoreStateRawData:function(o,i){var s=o[this.options.activePage];if("undo"==this.options.action){if(this.raw_undo_ver_list[this.options.activePage].length>0){var n=t.copy(s);if(this.raw_redo_ver_list[this.options.activePage].push(n),this.options.redoFlag=!0,this.raw_undo_ver_list[this.options.activePage].length>0){var e=t.copy(this.raw_undo_ver_list[this.options.activePage].pop());this.raw_undo_list[this.options.activePage]=e}}else if(this.options.undoFlag===!0){var n=t.copy(s);this.raw_redo_ver_list[this.options.activePage].push(n),this.raw_undo_list[this.options.activePage]=[],this.options.undoFlag=!1}this.setButtonStyle()}else{if(this.raw_redo_ver_list[this.options.activePage].length>0){if(this.raw_undo_list[this.options.activePage].length>0){var n=t.copy(this.raw_undo_list[this.options.activePage]);this.raw_undo_ver_list[this.options.activePage].push(n)}if(this.options.undoFlag=!0,this.raw_redo_ver_list[this.options.activePage].length>0){var a=t.copy(this.raw_redo_ver_list[this.options.activePage].pop()),r=a;this.raw_undo_list[this.options.activePage]=r}}else if(this.options.redoFlag===!0){var a=t.copy(this.raw_redo_ver_list[this.options.activePage].pop()),r=a;this.raw_undo_list[this.options.activePage]=r,this.options.redoFlag=!1}this.setButtonStyle()}},drawingState:function(t,o,i){if(i[this.options.activePage].length){var s=i[this.options.activePage][i[this.options.activePage].length-1],n=document.createElement("img");n.src=s,n.onload=function(){o.clearRect(0,0,r.history.options.canvas_width,r.history.options.canvas_height),o.drawImage(n,0,0,r.history.options.canvas_width,r.history.options.canvas_height),r.event.options.activeTool.drawTool()}}},redrawState:function(t,o){if(this.initial_canvas_url[this.options.activePage]){var i=this.initial_canvas_url[this.options.activePage],s=document.createElement("img");s.src=i,s.onload=function(){o.clearRect(0,0,r.history.options.canvas_width,r.history.options.canvas_height),o.drawImage(s,0,0,r.history.options.canvas_width,r.history.options.canvas_height),r.history.raw_undo_list[r.history.options.activePage].length>0&&r.move.redrawTool()}}},manageActiveBtn:function(t){for(var o=document.getElementsByClassName("controller active"),i=0;i<o.length;i++)o[i].classList.remove("active");""!==t&&(document.getElementById(t).className+=" active","clear_image"!==t&&r.options.toolsObj.frm_canvas_tool.reset())}},r.event={options:{activeTool:""},init:function(t,o){this.canvas=t,this.canvas_coords=this.canvas.getBoundingClientRect(),this.ctx=o,this.ctx.strokeColor=this.options.stroke_color,this.paging(),this.addCanvasEvents()},addCanvasEvents:function(){this.canvas.addEventListener("mousedown",this.start.bind(this)),this.canvas.addEventListener("mousemove",this.stroke.bind(this)),this.canvas.addEventListener("mouseup",this.stop.bind(this)),this.canvas.addEventListener("mouseout",this.stop.bind(this))},start:function(t){r.history.raw_undo_list[r.history.options.activePage].length>0&&(r.move.init(this.canvas,this.ctx),r.move.start(t)),r.move.options.movedObject==-1&&""!==this.options.activeTool&&void 0!==this.options.activeTool&&this.options.activeTool.start(t)},stroke:function(t){""!==this.options.activeTool&&void 0!==this.options.activeTool&&this.options.activeTool.drawing===!0&&this.options.activeTool.stroke(t)},stop:function(t){""!==this.options.activeTool&&void 0!==this.options.activeTool&&this.options.activeTool.drawing===!0&&this.options.activeTool.stop(t)},closepdf:function(){r.options.closeFn()},savepdf:function(){var t=confirm("Are you sure to you want to save file?");if(t){var o=new jsPDF("p","mm","a4");for(e=0;e<parseInt(r.history.options.totalPage);e++)if(e<2){if(r.history.final_canvas_url.hasOwnProperty(e))var i=r.history.final_canvas_url[e];else var i=document.getElementById("page"+e).toDataURL("image/png");o.addImage(i,"PNG",0,0,200,250,null,"SLOW"),e<parseInt(r.history.options.totalPage-1)&&o.addPage()}var s=o.output("datauristring"),n=this.dataURLtoBlob(s);"function"==typeof r.options.callbackFn?r.options.callbackFn({blob:n}):o.save()}},dataURLtoBlob:function(t){for(var o=t.split(","),i=o[0].match(/:(.*?);/)[1],s=atob(o[1]),n=s.length,e=new Uint8Array(n);n--;)e[n]=s.charCodeAt(n);return new Blob([e],{type:i})},paging:function(){r.history.options.totalPage=r.history.options.pdfobj.transport.numPages,r.options.toolsObj.activePage.textContent=r.history.options.activePage+1,r.options.toolsObj.currentPage.value=r.history.options.activePage+1,r.options.toolsObj.totalPage.textContent=r.history.options.totalPage,0===r.history.options.activePage?(r.options.toolsObj.prevBtn.setAttribute("disabled","disabled"),r.options.toolsObj.nextBtn.removeAttribute("disabled")):parseInt(r.history.options.activePage)===parseInt(r.history.options.totalPage-1)?(r.options.toolsObj.nextBtn.setAttribute("disabled","disabled"),r.options.toolsObj.prevBtn.removeAttribute("disabled")):r.history.options.activePage>0&&parseInt(r.history.options.activePage)<parseInt(r.history.options.totalPage-1)&&(r.options.toolsObj.prevBtn.removeAttribute("disabled"),r.options.toolsObj.nextBtn.removeAttribute("disabled"))}},r.text={name:"text",options:{stroke_color:["00","00","00"],fill_color:"#FF0000",font:"18px Arial",dim:4,lineHeight:14,finalTextInfo:[]},init:function(t,o){this.canvas=t,this.ctx=o,this.ctx.strokeColor=this.options.stroke_color,this.ctx.fillStyle="rgba(0,0,0,0)",this.drawing=!1,this.options.flag=!0},start:function(t){if(this.options.flag){this.canvas_coords=this.canvas.getBoundingClientRect();var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.startX=o,this.options.startY=i,this.options.endX=o,this.options.endY=i,this.ctx.fillStyle=this.options.fill_color,this.ctx.font=this.options.font,this.ctx.beginPath(),this.drawing=!0}},stroke:function(t){if(this.options.flag&&this.drawing){var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.endX=o,this.options.endY=i}},stop:function(t){this.drawing&&this.options.flag&&this.options.startX!==this.options.endX&&this.options.startY!==this.options.endY?(this.drawing=!1,this.options.flag=!1,this.options.lineHeight=parseInt(r.history.options.font_size),r.options.toolsObj.editor_wrapper.style.display="block",r.options.toolsObj.editor_wrapper.style.top=this.options.startY+this.canvas_coords.top-10,r.options.toolsObj.editor_wrapper.style.left=this.options.startX+this.canvas_coords.left,r.options.toolsObj.editor_wrapper.style.width=this.options.endX-this.options.startX,r.options.toolsObj.contenteditor.focus(),r.options.toolsObj.contenteditor.style.minHeight=parseInt(this.options.endY-this.options.startY)):(this.ctx.closePath(),this.ctx.stroke(),this.drawing=!1)},drawTool:function(){r.history.setStyleElement(this.canvas,this.ctx),r.options.toolsObj.contenteditor.style.fontSize=r.history.options.font_size,r.options.toolsObj.contenteditor.style.lineHeight=r.history.options.font_size+"px",r.options.toolsObj.contenteditor.style.height=r.options.toolsObj.contenteditor.scrollHeight+"px";var t=r.options.toolsObj.contenteditor.value,o=escape(t);if(t=unescape(o.replace(/%0A/g,"<br />").replace(/%20/g," ")),r.options.toolsObj.contenteditor.value="",""!==t){var i={text:t,x:this.options.startX,y:this.options.startY,boxWidth:this.options.endX-this.options.startX};this.drawStyledText(i),this.options.flag=!0}},drawStyledText:function(t){this.options.textInfo=t;var o,i,s,n,e,a,h=t.text,p=t.x,c=t.y,l=[],d=t.boxWidth,v=h.match(/<\s*br\s*\/>|<\s*class=["|']([^"|']+)["|']\s*\>([^>]+)<\s*\/class\s*\>|<\s*style=["|']([^"|']+)["|']\s*\>([^>]+)<\s*\/style\s*\>|[^<]+/g);for(a=0;a<v.length;a++)if(/<\s*br\s*\/>/i.test(v[a]))c+=1.5*parseInt(this.options.lineHeight,10),p=t.x;else{if(s=v[a],l=[],s=s.replace(/\s*\n\s*/g," "),void 0!==d&&this.checkLineBreak(s,d+t.x,p))if(o=this.trim(s).split(" "),1==o.length)l.push({text:this.trim(s)+" ",linebreak:!0});else{i=p;var g=0;for(l[g]={text:void 0,linebreak:!1},n=0;n<o.length;n++)o[n]+=" ",this.checkLineBreak(o[n],d+t.x,i)?(i=t.x,void 0!==l[g].text&&g++,l[g]={text:o[n],linebreak:!0},i+=this.ctx.measureText(o[n]).width):(void 0==l[g].text?l[g].text=o[n]:l[g].text+=o[n],i+=this.ctx.measureText(o[n]).width)}for(0==l.length&&l.push({text:this.trim(s)+" ",linebreak:!1}),e=0;e<l.length;e++)l[e].linebreak&&(c+=parseInt(this.options.lineHeight,10),p=t.x,this.options.endY=c),this.ctx.fillText(l[e].text,p,c),this.options.finalTextInfo.push({text:l[e].text,x:p,y:c}),p+=this.ctx.measureText(l[e].text).width}r.square.canvas=this.canvas,r.square.ctx=this.ctx,r.square.options.startX=this.options.startX-10,r.square.options.startY=this.options.startY-15,r.square.options.endX=this.options.endX,r.square.options.endY=this.options.endY+10,r.square.drawTool(),this.ctx.stroke(),r.history.setRawData(),r.history.saveState(this.canvas)},redrawTool:function(t,o,i){for(var s=0;s<t.length;s++)this.ctx.fillText(t[s].text,t[s].x+o,t[s].y+i);r.square.canvas=this.canvas,r.square.ctx=this.ctx,r.square.options.startX=this.options.startX-10,r.square.options.startY=this.options.startY-15,r.square.options.endX=this.options.endX,r.square.options.endY=this.options.endY+10,r.square.drawTool()},checkLineBreak:function(t,o,i){return this.ctx.measureText(t).width+i>o},trim:function(t){var o,i;for(t=t.replace(/^\s\s*/,""),o=/\s/,i=t.length;o.test(t.charAt(--i)););return t.slice(0,i+1)}},r.image={name:"image",options:{activeImage:"",uploadedImage:[],width:"",height:"",wdthHghtRatio:"",img:""},init:function(t,o){this.canvas=t,this.ctx=o,this.ctx.strokeColor=this.options.stroke_color,this.drawing=!1},start:function(t){this.canvas_coords=this.canvas.getBoundingClientRect();var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.startX=o,this.options.startY=i,this.options.endX=o,this.options.endY=i,this.ctx.beginPath(),this.drawing=!0},stroke:function(t){if(this.drawing){r.history.drawingState(this.canvas,this.ctx,r.history.undo_list);var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.endX=o,this.options.endY=i,this.drawTool()}},stop:function(t){this.drawing&&this.options.startX!==this.options.endX&&this.options.startY!==this.options.endY?(this.ctx.beginPath(),this.drawTool(),this.ctx.closePath(),this.ctx.stroke(),this.drawing=!1,r.history.setRawData(),r.history.saveState(this.canvas)):(this.ctx.closePath(),this.ctx.stroke(),this.drawing=!1)},drawTool:function(){this.ctx.beginPath(),r.history.setStyleElement(this.canvas,this.ctx),this.options.width=parseInt(this.options.endX-this.options.startX),this.options.height=parseInt(this.options.endY-this.options.startY),this.ctx.drawImage(this.options.img,this.options.startX,this.options.startY,this.options.width,this.options.height),this.ctx.closePath(),this.ctx.beginPath(),this.ctx.lineWidth=3,this.ctx.strokeStyle="#000000",this.ctx.rect(this.options.startX+2,this.options.startY+2,this.options.width-4,this.options.height-4),this.ctx.stroke(),this.ctx.closePath(),this.ctx.beginPath(),this.ctx.lineWidth=1,this.ctx.fillStyle="#FFFFFF",r.image.options.endX=r.image.options.startX+r.image.options.width,r.image.options.endY=r.image.options.startY+r.image.options.height,this.ctx.rect(r.image.options.startX,r.image.options.startY,8,8),this.ctx.rect(r.image.options.startX,r.image.options.endY-8,8,8),this.ctx.rect(r.image.options.endX-8,r.image.options.endY-8,8,8),this.ctx.rect(r.image.options.endX-8,r.image.options.startY,8,8),this.ctx.rect(r.image.options.endX-r.image.options.width,r.image.options.endY-parseInt(r.image.options.height/2)-8,8,8),this.ctx.rect(r.image.options.endX-8,r.image.options.endY-parseInt(r.image.options.height/2)-8,8,8),this.ctx.rect(r.image.options.endX-parseInt(r.image.options.width/2)-8,r.image.options.endY-8,8,8),this.ctx.rect(r.image.options.endX-parseInt(r.image.options.width/2)-8,r.image.options.endY-r.image.options.height,8,8),this.ctx.fill(),this.ctx.stroke(),this.ctx.closePath()},uploadImage:function(t){var o=new Image;o.onload=function(t){r.image.options.startX=10,r.image.options.startY=10,r.image.options.endX=t.path[0].width,r.image.options.endY=t.path[0].height,r.image.ctx.beginPath(),r.image.drawing=!0,r.history.drawingState(r.image.canvas,r.image.ctx,r.history.undo_list),r.image.drawTool(),r.image.ctx.closePath(),r.image.ctx.stroke(),r.image.drawing=!1,r.history.setRawData(),r.history.saveState(r.image.canvas)},o.src=URL.createObjectURL(t),this.options.uploadedImage.push(URL.createObjectURL(t)),this.options.img=o}},r.arrow={name:"arrow",options:{stroke_color:["00","00","00"],dim:4,arrow:{h:5,w:10},headlen:10},init:function(t,o){this.canvas=t,this.ctx=o,this.ctx.strokeColor=this.options.stroke_color,this.ctx.fillStyle="rgba(0,0,0,0)",this.drawing=!1},start:function(t){this.canvas_coords=this.canvas.getBoundingClientRect();var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.startX=o,this.options.startY=i,this.options.endX=o,this.options.endY=i,this.ctx.beginPath(),this.drawing=!0},stroke:function(t){if(this.drawing){r.history.drawingState(this.canvas,this.ctx,r.history.undo_list);var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.endX=o,this.options.endY=i,this.drawTool()}},stop:function(t){this.drawing&&this.options.startX!==this.options.endX&&this.options.startY!==this.options.endY?(this.ctx.beginPath(),this.drawTool(),this.ctx.closePath(),this.ctx.stroke(),this.drawing=!1,r.history.setRawData(),r.history.saveState(this.canvas)):(this.ctx.closePath(),this.ctx.stroke(),this.drawing=!1)},drawTool:function(){this.ctx.beginPath(),r.history.setStyleElement(this.canvas,this.ctx);var t=Math.atan2(this.options.endY-this.options.startY,this.options.endX-this.options.startX);this.ctx.moveTo(this.options.startX,this.options.startY),this.ctx.lineTo(this.options.endX,this.options.endY),this.ctx.lineTo(this.options.endX-this.options.headlen*Math.cos(t-Math.PI/6),this.options.endY-this.options.headlen*Math.sin(t-Math.PI/6)),this.ctx.moveTo(this.options.endX,this.options.endY),this.ctx.lineTo(this.options.endX-this.options.headlen*Math.cos(t+Math.PI/6),this.options.endY-this.options.headlen*Math.sin(t+Math.PI/6)),this.ctx.stroke()}},r.line={name:"line",options:{stroke_color:["00","00","00"],dim:4},init:function(t,o){this.canvas=t,this.ctx=o,this.ctx.strokeColor=this.options.stroke_color,this.ctx.fillStyle="rgba(0,0,0,0)",this.drawing=!1},start:function(t){this.canvas_coords=this.canvas.getBoundingClientRect();var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.startX=o,this.options.startY=i,this.options.endX=o,this.options.endY=i,this.ctx.beginPath(),this.drawing=!0},stroke:function(t){if(this.drawing){r.history.drawingState(this.canvas,this.ctx,r.history.undo_list);var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.endX=o,this.options.endY=i,this.drawTool()}},stop:function(t){this.drawing&&this.options.startX!==this.options.endX&&this.options.startY!==this.options.endY?(this.ctx.beginPath(),this.drawTool(),this.ctx.closePath(),this.ctx.stroke(),this.drawing=!1,r.history.setRawData(),r.history.saveState(this.canvas)):(this.ctx.closePath(),this.ctx.stroke(),this.drawing=!1)},drawTool:function(){this.ctx.beginPath(),r.history.setStyleElement(this.canvas,this.ctx),this.ctx.moveTo(this.options.startX,this.options.startY),this.ctx.lineTo(this.options.endX,this.options.endY),this.ctx.stroke()},redrawTool:function(){this.ctx.beginPath(),r.history.setStyleElement(this.canvas,this.ctx),this.ctx.moveTo(this.options.startX,this.options.startY),this.ctx.lineTo(this.options.endX,this.options.endY),this.ctx.stroke()}},r.circle={name:"circle",options:{stroke_color:["00","00","00"],dim:4},init:function(t,o){this.canvas=t,this.ctx=o,this.ctx.strokeColor=this.options.stroke_color,this.ctx.fillStyle="rgba(0,0,0,0)",this.drawing=!1},start:function(t){this.canvas_coords=this.canvas.getBoundingClientRect();var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.startX=o,this.options.startY=i,this.options.endX=o,this.options.endY=i,this.ctx.beginPath(),this.drawing=!0},stroke:function(t){if(this.drawing){var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.endX=o,this.options.endY=i,r.history.drawingState(this.canvas,this.ctx,r.history.undo_list)}},stop:function(t){this.drawing&&this.options.startX!==this.options.endX&&this.options.startY!==this.options.endY?(this.drawTool(),this.ctx.closePath(),this.ctx.stroke(),this.drawing=!1,r.history.setRawData(),r.history.saveState(this.canvas)):(this.ctx.closePath(),this.ctx.stroke(),this.drawing=!1)},drawTool:function(){if(this.drawing){r.history.setStyleElement(this.canvas,this.ctx);var t=parseInt(this.options.endX-this.options.startX),o=parseInt(this.options.endY-this.options.startY),i=t+o,s=2*Math.PI/i;this.options.radius=i,this.ctx.beginPath();for(var n=0;n<2*Math.PI;n+=s){var e=t+i*Math.cos(n),a=o-i*Math.sin(n);this.ctx.lineTo(e+this.options.startX,a+this.options.startY)}this.ctx.stroke()}}},r.ellipse={name:"ellipse",options:{stroke_color:["00","00","00"],dim:4},init:function(t,o){this.canvas=t,this.ctx=o,this.ctx.strokeColor=this.options.stroke_color,this.ctx.fillStyle="rgba(0,0,0,0)",this.drawing=!1},start:function(t){this.canvas_coords=this.canvas.getBoundingClientRect();var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.startX=o,this.options.startY=i,this.options.endX=o,this.options.endY=i,this.ctx.beginPath(),this.drawing=!0},stroke:function(t){if(this.drawing){var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.endX=o,this.options.endY=i,r.history.drawingState(this.canvas,this.ctx,r.history.undo_list)}},stop:function(t){this.drawing&&this.options.startX!==this.options.endX&&this.options.startY!==this.options.endY?(this.drawTool(),this.ctx.closePath(),this.ctx.stroke(),this.drawing=!1,r.history.setRawData(),r.history.saveState(this.canvas)):(this.ctx.closePath(),this.ctx.stroke(),this.drawing=!1)},drawTool:function(){if(this.drawing){for(r.history.setStyleElement(this.canvas,this.ctx),this.ctx.beginPath(),a=0*Math.PI;a<2*Math.PI;a+=.01)xPos=Math.floor(this.options.startX-parseInt(this.options.endX-this.options.startX)*Math.cos(a)),yPos=Math.floor(this.options.startY+parseInt(this.options.endY-this.options.startY)*Math.sin(a)),0==a?this.ctx.moveTo(xPos,yPos):this.ctx.lineTo(xPos,yPos);this.ctx.stroke()}}},r.pencil={name:"pencil",options:{stroke_color:["00","00","00"],dim:4},init:function(t,o){this.canvas=t,this.ctx=o,this.ctx.strokeColor=this.options.fillStyle,this.drawing=!1},start:function(t){r.history.setStyleElement(this.canvas,this.ctx),this.canvas_coords=this.canvas.getBoundingClientRect();var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.startX=o,this.options.startY=i,this.options.endX=0,this.options.endY=0,this.ctx.beginPath(),this.ctx.moveTo(this.options.startX,this.options.startY),r.history.setRawData(),this.drawing=!0},stroke:function(t){if(this.drawing){var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.startX=o,this.options.startY=i,this.options.endX=0,this.options.endY=0,this.ctx.lineTo(this.options.startX,this.options.startY),r.history.setRawData(),this.ctx.stroke()}},stop:function(t){this.drawing&&(this.drawing=!1,r.history.saveState(this.canvas))},drawTool:function(){},redrawTool:function(){this.ctx.beginPath();for(var t=0;t<this.options.pencilData.length;t++)0==t?this.ctx.moveTo(this.options.pencilData[t].x+this.options.diffX,this.options.pencilData[t].y+this.options.diffY):this.ctx.lineTo(this.options.pencilData[t].x+this.options.diffX,this.options.pencilData[t].y+this.options.diffY);this.ctx.stroke()}},r.move={name:"move",options:{arrTool:["square","circle","text","image","line","arrow","ellipse"],prevTool:"",movedObject:-1,cursorStyle:"move",isResize:!1,arrResize:{startX:!1,startY:!1,endX:!1,endY:!1},resizeMargin:10},init:function(t,o){this.canvas=t,this.canvas_coords=this.canvas.getBoundingClientRect(),this.ctx=o,this.drawing=!1},start:function(t){var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;return this.options.startX=o,this.options.startY=i,this.options.startDiffX=t.pageX,this.options.startDiffY=t.pageY,this.options.cursorStyle="move",this.hitTest(),!(this.options.movedObject>=0)||(this.options.prevTool=r.event.options.activeTool,r.event.options.activeTool=r.move,r.options.toolsObj.canvas.style.cursor=this.options.cursorStyle,void(this.drawing=!0))},stroke:function(t){if(this.drawing){var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.endX=o,this.options.endY=i,this.options.endDiffX=t.pageX,this.options.endDiffY=t.pageY,this.options.diffX=this.options.endDiffX-this.options.startDiffX,this.options.diffY=this.options.endDiffY-this.options.startDiffY,r.history.redrawState(this.canvas,this.ctx)}},stop:function(o){if(this.drawing){if(this.drawing=!1,this.options.movedObject>=0&&(this.options.startX-this.options.endX!==0||this.options.startY-this.options.endY!==0)&&void 0!=this.options.endX)if(r.history.tmp_raw_undo_list=t.copy(r.history.raw_undo_list[r.history.options.activePage]),this.options.arrTool.indexOf(r.history.options.arrData.name)>-1){if(this.options.isResize===!1?(r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].startX[0]=r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].startX[0]+this.options.diffX,r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].startY[0]=r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].startY[0]+this.options.diffY,r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].endX[0]=r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].endX[0]+this.options.diffX,r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].endY[0]=r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].endY[0]+this.options.diffY):(this.options.arrResize.startX===!0&&(r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].startX[0]=r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].startX[0]+this.options.diffX),this.options.arrResize.startY===!0&&(r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].startY[0]=r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].startY[0]+this.options.diffY),this.options.arrResize.endX===!0&&(r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].endX[0]=r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].endX[0]+this.options.diffX),this.options.arrResize.endY===!0&&(r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].endY[0]=r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].endY[0]+this.options.diffY)),"text"==r.history.options.arrData.name){for(var i=0;i<r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].finalTextInfo.length;i++)r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].finalTextInfo[i].x=r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].finalTextInfo[i].x+this.options.diffX,r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].finalTextInfo[i].y=r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].finalTextInfo[i].y+this.options.diffY;r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].textInfo.x+=this.options.diffX,r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].textInfo.y+=this.options.diffY}}else for(var i=0;i<r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].pencilData.length;i++)r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].pencilData[i].x=r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].pencilData[i].x+this.options.diffX,r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].pencilData[i].y=r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].pencilData[i].y+this.options.diffY;r.options.optionArrData=r.history.options.arrData={startX:[],startY:[],endX:[],endY:[],pencilData:[]},r.history.saveState(this.canvas),this.options.movedObject=-1,this.options.cursorStyle="default",r.options.toolsObj.canvas.style.cursor=this.options.cursorStyle,this.options.arrResize={startX:!1,startY:!1,endX:!1,endY:!1},this.options.isResize=!1,""!=this.options.prevTool&&(r.event.options.activeTool=this.options.prevTool,this.options.prevTool="")}},drawTool:function(){if(this.ctx.beginPath(),this.drawing){var t=r.history.options.arrData.name;"square"===t&&(r.square.init(this.canvas,this.ctx),r.square.options.startX=r.history.options.arrData.startX[0]+this.options.diffX,r.square.options.startY=r.history.options.arrData.startY[0]+this.options.diffY,r.square.options.endX=r.history.options.arrData.endX[0]+this.options.diffX,r.square.options.endY=r.history.options.arrData.endY[0]+this.options.diffY,r.square.drawTool())}this.ctx.stroke()},redrawTool:function(){var t=r.history.raw_undo_list[r.history.options.activePage],o=t.length-1;if(o>=0){for(e=0;e<=o;e++){if(this.ctx.beginPath(),r.history.options.font_size=t[e].font_size,r.history.options.fillStyle=t[e].fillStyle,r.history.options.lineWidth=t[e].lineWidth,r.history.setStyleElement(this.canvas,this.ctx),this.options.arrTool.indexOf(t[e].name)>-1){if("square"===t[e].name&&(this.options.currentDrawTool=r.square),
"circle"===t[e].name&&(this.options.currentDrawTool=r.circle),"image"===t[e].name){this.options.currentDrawTool=r.image,this.options.currentDrawTool.options.img=t[e].imageURL;var i=new Image;i.onload=function(t){},i.src=this.options.currentDrawTool.options.img,this.options.currentDrawTool.options.img=i}if("line"===t[e].name&&(this.options.currentDrawTool=r.line),"arrow"===t[e].name&&(this.options.currentDrawTool=r.arrow),"ellipse"===t[e].name&&(this.options.currentDrawTool=r.ellipse),"text"===t[e].name&&(this.options.currentDrawTool=r.text),this.options.currentDrawTool.drawing=!0,this.options.movedObject==e&&this.options.isResize===!0?(this.options.arrResize.startX===!0?this.options.currentDrawTool.options.startX=r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].startX[0]+this.options.diffX:this.options.currentDrawTool.options.startX=r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].startX[0],this.options.arrResize.startY===!0?this.options.currentDrawTool.options.startY=r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].startY[0]+this.options.diffY:this.options.currentDrawTool.options.startY=r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].startY[0],this.options.arrResize.endX===!0?this.options.currentDrawTool.options.endX=r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].endX[0]+this.options.diffX:this.options.currentDrawTool.options.endX=r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].endX[0],this.options.arrResize.endY===!0?this.options.currentDrawTool.options.endY=r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].endY[0]+this.options.diffY:this.options.currentDrawTool.options.endY=r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].endY[0]):this.options.movedObject==e?(this.options.currentDrawTool.options.startX=r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].startX[0]+this.options.diffX,this.options.currentDrawTool.options.startY=r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].startY[0]+this.options.diffY,this.options.currentDrawTool.options.endX=r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].endX[0]+this.options.diffX,this.options.currentDrawTool.options.endY=r.history.raw_undo_list[r.history.options.activePage][this.options.movedObject].endY[0]+this.options.diffY):(this.options.currentDrawTool.options.startX=t[e].startX[0],this.options.currentDrawTool.options.startY=t[e].startY[0],this.options.currentDrawTool.options.endX=t[e].endX[0],this.options.currentDrawTool.options.endY=t[e].endY[0]),"text"===t[e].name){var s=0,n=0;this.options.movedObject===e&&(s=this.options.diffX,n=this.options.diffY),this.options.currentDrawTool.redrawTool(t[e].finalTextInfo,s,n)}else this.options.currentDrawTool.drawTool();this.options.currentDrawTool.drawing=!1}else"pencil"===t[e].name&&(this.options.currentDrawTool=r.pencil,this.options.currentDrawTool.options.pencilData=t[e].pencilData,this.options.movedObject==e?(this.options.currentDrawTool.options.diffX=this.options.endX-this.options.startX,this.options.currentDrawTool.options.diffY=this.options.endY-this.options.startY):(this.options.currentDrawTool.options.diffX=0,this.options.currentDrawTool.options.diffY=0)),this.options.currentDrawTool&&(this.options.currentDrawTool.drawing=!0,"pencil"===t[e].name?this.options.currentDrawTool.redrawTool():this.options.currentDrawTool.drawTool(),this.options.currentDrawTool.drawing=!1);this.ctx.stroke()}var a=this.canvas.toDataURL();r.history.undo_list[r.history.options.activePage][0]=a,r.history.resetStyleElement()}},resizeCheck:function(t,o,i,s){this.options.startX>=t&&this.options.startX<=t+this.options.resizeMargin&&this.options.startY>=o&&this.options.startY<=o+this.options.resizeMargin?(this.options.arrResize.startX=!0,this.options.arrResize.startY=!0,this.options.arrResize.endX=!1,this.options.arrResize.endY=!1,this.options.cursorStyle="nwse-resize",this.options.isResize=!0):this.options.startX<=i&&this.options.startX>=i-this.options.resizeMargin&&this.options.startY<=s&&this.options.startY>=s-this.options.resizeMargin?(this.options.arrResize.startX=!1,this.options.arrResize.startY=!1,this.options.arrResize.endX=!0,this.options.arrResize.endY=!0,this.options.cursorStyle="nwse-resize",this.options.isResize=!0):this.options.startX>=t&&this.options.startX<=t+this.options.resizeMargin&&this.options.startY<=s&&this.options.startY>=s-this.options.resizeMargin?(this.options.arrResize.startX=!0,this.options.arrResize.startY=!1,this.options.arrResize.endX=!1,this.options.arrResize.endY=!0,this.options.cursorStyle="nesw-resize",this.options.isResize=!0):this.options.startX<=i&&this.options.startX>=i-this.options.resizeMargin&&this.options.startY>=o&&this.options.startY<=o+this.options.resizeMargin?(this.options.arrResize.startX=!1,this.options.arrResize.startY=!0,this.options.arrResize.endX=!0,this.options.arrResize.endY=!1,this.options.cursorStyle="nesw-resize",this.options.isResize=!0):this.options.startX>=t&&this.options.startX<=t+this.options.resizeMargin?(this.options.arrResize.startX=!0,this.options.arrResize.startY=!1,this.options.arrResize.endX=!1,this.options.arrResize.endY=!1,this.options.cursorStyle="ew-resize",this.options.isResize=!0):this.options.startX<=i&&this.options.startX>=i-this.options.resizeMargin?(this.options.arrResize.startX=!1,this.options.arrResize.startY=!1,this.options.arrResize.endX=!0,this.options.arrResize.endY=!1,this.options.cursorStyle="ew-resize",this.options.isResize=!0):this.options.startY>=o&&this.options.startY<=o+this.options.resizeMargin?(this.options.arrResize.startX=!1,this.options.arrResize.startY=!0,this.options.arrResize.endX=!1,this.options.arrResize.endY=!1,this.options.cursorStyle="ns-resize",this.options.isResize=!0):this.options.startY<=s&&this.options.startY>=s-this.options.resizeMargin&&(this.options.arrResize.startX=!1,this.options.arrResize.startY=!1,this.options.arrResize.endX=!1,this.options.arrResize.endY=!0,this.options.cursorStyle="ns-resize",this.options.isResize=!0)},hitTest:function(){var t=r.history.raw_undo_list[r.history.options.activePage],o=t.length-1;for(this.options.movedObject=-1,e=o;e>=0&&!(this.options.movedObject>-1);e--){if(r.history.options.arrData=t[e],"square"===r.history.options.arrData.name&&this.options.startX>=r.history.options.arrData.startX[0]&&this.options.startX<=r.history.options.arrData.endX[0]&&this.options.startY>=r.history.options.arrData.startY[0]&&this.options.startY<=r.history.options.arrData.endY[0]){this.options.movedObject=e;break}if("image"===r.history.options.arrData.name&&this.options.startX>=r.history.options.arrData.startX[0]&&this.options.startX<=r.history.options.arrData.endX[0]&&this.options.startY>=r.history.options.arrData.startY[0]&&this.options.startY<=r.history.options.arrData.endY[0]){this.options.movedObject=e,this.resizeCheck(r.history.options.arrData.startX[0],r.history.options.arrData.startY[0],r.history.options.arrData.endX[0],r.history.options.arrData.endY[0]);break}if("text"===r.history.options.arrData.name&&this.options.startX>=r.history.options.arrData.startX[0]&&this.options.startX<=r.history.options.arrData.endX[0]&&this.options.startY>=r.history.options.arrData.startY[0]&&this.options.startY<=r.history.options.arrData.endY[0]){this.options.movedObject=e;break}if("pencil"===r.history.options.arrData.name&&r.history.options.arrData.pencilData.length>0)for(c=0;c<r.history.options.arrData.pencilData.length;c++)if(parseInt(r.history.options.arrData.pencilData[c].x-4)<=this.options.startX&&parseInt(r.history.options.arrData.pencilData[c].x+4)>=this.options.startX&&parseInt(r.history.options.arrData.pencilData[c].y-4)<=this.options.startY&&parseInt(r.history.options.arrData.pencilData[c].y+4)>=this.options.startY){this.options.movedObject=e;break}if("circle"===r.history.options.arrData.name){var i=t[e].radius,s=t[e].startX[0]-this.options.startX,n=t[e].startY[0]-this.options.startY;if(parseInt(s*s+n*n)<parseInt(i*i)){this.options.movedObject=e;break}}if("ellipse"===r.history.options.arrData.name){var a=0,h=1e8,p=0;this.options.startX=Math.floor(this.options.startX);for(var c=0*Math.PI;c<2*Math.PI;c+=.01)xPos=Math.floor(r.history.options.arrData.startX[0]-parseInt(r.history.options.arrData.endX[0]-r.history.options.arrData.startX[0])*Math.cos(c)),yPos=Math.floor(r.history.options.arrData.startY[0]+parseInt(r.history.options.arrData.endY[0]-r.history.options.arrData.startY[0])*Math.sin(c)),this.options.startX>=xPos-5&&this.options.startX<=xPos+5&&(this.options.startX==xPos&&(p=xPos),h>yPos&&(h=yPos),a<yPos&&(a=yPos));if(this.options.startX==p&&this.options.startY>h&&this.options.startY<a){this.options.movedObject=e;break}}if("line"===r.history.options.arrData.name){if(r.history.options.arrData.endX[0]<r.history.options.arrData.startX[0])var l=r.history.options.arrData.endX[0],d=r.history.options.arrData.startX[0];else var l=r.history.options.arrData.startX[0],d=r.history.options.arrData.endX[0];if(r.history.options.arrData.endY[0]<r.history.options.arrData.startY[0])var v=r.history.options.arrData.endY[0],g=r.history.options.arrData.startY[0];else var v=r.history.options.arrData.startY[0],g=r.history.options.arrData.endY[0];if(this.options.startX>=l&&this.options.startX<=d&&this.options.startY>=v&&this.options.startY<=g){var u=Math.atan2(this.options.startY-r.history.options.arrData.startY[0],this.options.startX-r.history.options.arrData.startX[0]),y=Math.abs(u)-Math.abs(r.history.options.arrData.lineAngle);if(Math.abs(y)<.2){this.options.movedObject=e;break}}}if("arrow"===r.history.options.arrData.name){if(r.history.options.arrData.endX[0]<r.history.options.arrData.startX[0])var l=r.history.options.arrData.endX[0],d=r.history.options.arrData.startX[0];else var l=r.history.options.arrData.startX[0],d=r.history.options.arrData.endX[0];if(r.history.options.arrData.endY[0]<r.history.options.arrData.startY[0])var v=r.history.options.arrData.endY[0],g=r.history.options.arrData.startY[0];else var v=r.history.options.arrData.startY[0],g=r.history.options.arrData.endY[0];if(this.options.startX>=l&&this.options.startX<=d&&this.options.startY>=v&&this.options.startY<=g){var u=Math.atan2(this.options.startY-r.history.options.arrData.startY[0],this.options.startX-r.history.options.arrData.startX[0]),y=Math.abs(u)-Math.abs(r.history.options.arrData.arrowAngle);if(Math.abs(y)<.2){this.options.movedObject=e;break}}}}}},r.square={name:"square",options:{stroke_color:["00","00","00"],dim:4},init:function(t,o){this.canvas=t,this.ctx=o,this.drawing=!1},start:function(t){this.canvas_coords=this.canvas.getBoundingClientRect();var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.startX=o,this.options.startY=i,this.options.endX=o,this.options.endY=i,this.ctx.beginPath(),this.drawing=!0},stroke:function(t){if(this.drawing){r.history.drawingState(this.canvas,this.ctx,r.history.undo_list),this.ctx.beginPath();var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.endX=o,this.options.endY=i,this.drawTool()}},stop:function(t){this.drawing&&this.options.startX!==this.options.endX&&this.options.startY!==this.options.endY?(this.ctx.beginPath(),this.options.width=this.options.endX-this.options.startX,this.options.height=this.options.endY-this.options.startY,this.drawTool(),this.ctx.stroke(),this.drawing=!1,r.history.setRawData(),r.history.saveState(this.canvas)):(this.ctx.closePath(),this.ctx.stroke(),this.drawing=!1)},drawLine:function(t,o){r.history.setStyleElement(this.canvas,this.ctx),this.ctx.moveTo(t.x,t.y),this.ctx.lineTo(o.x,o.y),this.ctx.stroke()},drawTool:function(){o={x:this.options.startX,y:this.options.startY,r:0},i={x:this.options.startX,y:this.options.endY,r:0},s={x:this.options.endX,y:this.options.endY,r:0},n={x:this.options.endX,y:this.options.startY,r:0},this.drawLine(o,i),this.drawLine(i,s),this.drawLine(s,n),this.drawLine(n,o)}},r.renderPage=function(t){var o=t.getViewport(r.options.pdfOptions.scale),i=document.createElement("canvas"),s=i.getContext("2d"),n={canvasContext:s,viewport:o};i.setAttribute("id","page"+t.pageIndex),i.height=o.height,i.width=o.width,r.history.options.canvas_width=i.width,r.history.options.canvas_height=i.height,r.options.toolsObj.canvasContainer.appendChild(i);var e=t.render(n);e.promise.then(function(){r.options.bindCnt++,""===r.options.bindFlag&&t.transport.numPages==r.options.bindCnt&&(r.history.options.pdfobj=t,r.bindEvent(0),r.options.bindFlag=1)})},r.bindEvent=function(t){if(""==r.options.bindFlag){if(r.options.bindFlag="true",r.history.options.PrevPage=t,r.history.options.activePage=t,r.options.canvas=r.options.toolsObj.canvas,r.options.ctx=r.options.canvas.getContext("2d"),r.history.initial_canvas_url.hasOwnProperty(t))r.options.imgURL=r.history.final_canvas_url[r.history.options.activePage];else{var o=document.getElementById("page"+t);r.history.initial_canvas_url[t]=o.toDataURL(),r.history.final_canvas_url[r.history.options.activePage]=r.history.initial_canvas_url[r.history.options.activePage],r.options.imgURL=r.history.initial_canvas_url[r.history.options.activePage]}r.options.canvas.height=r.history.options.canvas_height,r.options.canvas.width=r.history.options.canvas_width;var i=document.createElement("img");i.src=r.options.imgURL,i.onload=function(){r.options.canvas_coords=r.options.canvas.getBoundingClientRect(),r.history.options.canvas_coords=r.options.canvas_coords,r.options.ctx.clearRect(0,0,r.options.canvas.width,r.options.canvas.height),r.options.ctx.drawImage(i,0,0,r.options.canvas.width,r.options.canvas.height),r.options.toolsObj.loading.textContent="",r.history.saveState(r.options.canvas),r.options.btnFlag===!1&&(r.options.btnFlag=!0,r.options.toolsObj.pencil.addEventListener("click",function(){r.event.options.activeTool=r.pencil,r.history.manageActiveBtn("pencil"),r.pencil.init(r.options.canvas,r.options.ctx)}),r.options.toolsObj.square.addEventListener("click",function(){r.event.options.activeTool=r.square,r.history.manageActiveBtn("square"),r.square.init(r.options.canvas,r.options.ctx)}),r.options.toolsObj.circle.addEventListener("click",function(){r.event.options.activeTool=r.circle,r.history.manageActiveBtn("circle"),r.circle.init(r.options.canvas,r.options.ctx)}),r.options.toolsObj.ellipse.addEventListener("click",function(){r.event.options.activeTool=r.ellipse,r.history.manageActiveBtn("ellipse"),r.ellipse.init(r.options.canvas,r.options.ctx)}),r.options.toolsObj.text.addEventListener("click",function(){r.event.options.activeTool=r.text,r.history.manageActiveBtn("text"),r.text.init(r.options.canvas,r.options.ctx)}),r.options.toolsObj.contenteditor.addEventListener("blur",function(){r.options.toolsObj.editor_wrapper.style.display="none",r.text.drawTool()}),r.options.toolsObj.arrow.addEventListener("click",function(){r.event.options.activeTool=r.arrow,r.history.manageActiveBtn("arrow"),r.arrow.init(r.options.canvas,r.options.ctx)}),r.options.toolsObj.line.addEventListener("click",function(){r.event.options.activeTool=r.line,r.history.manageActiveBtn("line"),r.line.init(r.options.canvas,r.options.ctx)}),r.options.toolsObj.imageupload.addEventListener("change",function(){r.image.uploadImage(this.files[0]),r.event.options.activeTool=r.image,r.history.manageActiveBtn("clear_image"),r.image.init(r.options.canvas,r.options.ctx)}),r.options.toolsObj.clear_image.addEventListener("click",function(){r.options.toolsObj.frm_canvas_tool.reset()}),r.options.toolsObj.undo.addEventListener("click",function(){r.history.undo(r.options.canvas,r.options.ctx)}),r.options.toolsObj.redo.addEventListener("click",function(){r.history.redo(r.options.canvas,r.options.ctx)}),r.options.toolsObj.save.addEventListener("click",function(){r.event.options.activeTool="",r.history.manageActiveBtn(""),r.event.savepdf()}),r.options.toolsObj.fontsize.addEventListener("change",function(){r.history.options.font_size=this.value}),r.options.toolsObj.fillstyle.addEventListener("change",function(){r.history.options.fillStyle="#"+this.value}),r.options.toolsObj.linewidth.addEventListener("change",function(){r.history.options.lineWidth=this.value}),r.options.toolsObj.prevBtn.addEventListener("click",function(){r.options.toolsObj.prevBtn.getAttribute("disable")||(r.options.bindFlag="",r.bindEvent(parseInt(r.history.options.activePage-1)))}),r.options.toolsObj.nextBtn.addEventListener("click",function(){r.options.toolsObj.nextBtn.getAttribute("disabled")||(r.options.bindFlag="",r.bindEvent(parseInt(r.history.options.activePage+1)))}),r.options.toolsObj.fontsize.value=r.history.options.font_size,r.options.toolsObj.fillstyle.value=r.history.options.fillStyle,r.options.toolsObj.linewidth.value=r.history.options.lineWidth),r.event.init(r.options.canvas,r.options.ctx),r.history.setButtonStyle()}}},r.renderPages=function(t){r.history.options.numPages=t.numPages;for(var o=1;o<=t.numPages;o++)t.getPage(o).then(r.renderPage)},r.renderPDF=function(t,o,i){this.options.pdfOptions=i||{scale:2},r.options.toolsObj.loading.textContent="Wait while loading PDF file...",PDFJS.disableWorker=!1,PDFJS.workerSrc=r.options.pdfWorker,PDFJS.getDocument(t).then(r.renderPages)},r}),o.directive("pdfAnnotation",["pdfAnnotationFactory",function(o){return{restrict:"E",scope:{options:"=",callbackFn:"&",closeFn:"&"},transclude:!0,template:'<div id="controllers"><a href="#" id="close" ng-show="options.enableCloseBtn" class="close">&nbsp;</a><span class="controller btn btn-icn" id="pencil" title="Freehand Drawing"></span><span class="controller btn btn-icn" id="square" title="Square"></span><span class="controller btn btn-icn" id="circle" title="Circle"></span><span class="controller btn btn-icn" id="ellipse" title="Ellipse"></span><span class="controller btn btn-icn" id="text" title="Text"></span><span class="controller btn btn-icn" id="arrow" title="Arrow"></span><span class="controller btn btn-icn" id="line" title="Line"></span><span class="controller btn btn-icn" id="undo" title="Undo"></span><span class="controller btn btn-icn" id="redo" title="Redo"></span><span class="controller title" id="activePage" disabled="disabled"></span>&nbsp; out of&nbsp;<span class="controller title" id="totalPage" disabled="disabled"></span><span class="controller btn" id="prevBtn"><</span> &nbsp;<input type="text" class="pagenumber" name="currentPage" id="currentPage" />&nbsp;<span class="controller btn" id="nextBtn">></span><span class="controller btn btn-icn" id="save" title="Save"></span><br /><br /><form id="frm_canvas_tool"><input name="imageupload" id="imageupload" class="input_file" type="file" accept="image/*" ><span class="controller btn" id="clear_image">Clear Image</span></form>    Font Size:<select id="fontsize" name="fontsize"><option value="">Select Font Size</option><option value="2">2px</option><option value="5">5px</option><option value="7">7px</option><option value="8">8px</option><option value="9">9px</option><option value="10">10px</option><option value="11">11px</option><option value="12">12px</option><option value="13">13px</option><option value="14">14px</option><option value="16">16px</option><option value="18">18px</option><option value="32">32px</option></select>    Color:<select id="fillstyle" name="fillstyle"><option>Select Color</option><option value="FF0000">Red</option><option value="00FF00">Green</option><option value="0000FF">Blue</option><option value="000000">Black</option><option value="FFFFFF">White</option></select>    Line Width:<select id="linewidth" name="linewidth"><option value="">Select Font Size</option><option value="2">2px</option><option value="5">5px</option><option value="7">7px</option><option value="8">8px</option></select><span class="controller" id="loading"></span></div><div id="canvas-container" class="canvas-container" style="visibility: hidden; height: 0px;"></div><div id="canvas-cont" class="canvas-container"><canvas id="canvas"></canvas><div id="editor_wrapper" style="display:none;"><textarea id="contenteditor" rows="10"></textarea></div></div><div ng-if="errorURL"><h1>URL not found!</h1></div>',link:function(i,s,n,e){console.log("Scope:",i),o.options.closeFn=i.closeFn,o.options.callbackFn=i.callbackFn,o.options.toolsObj.loading=t.element(document.querySelector("#loading"))[0],o.options.toolsObj.pencil=t.element(document.querySelector("#pencil"))[0],o.options.toolsObj.square=t.element(document.querySelector("#square"))[0],o.options.toolsObj.circle=t.element(document.querySelector("#circle"))[0],o.options.toolsObj.ellipse=t.element(document.querySelector("#ellipse"))[0],o.options.toolsObj.text=t.element(document.querySelector("#text"))[0],o.options.toolsObj.contenteditor=t.element(document.querySelector("#contenteditor"))[0],o.options.toolsObj.editor_wrapper=t.element(document.querySelector("#editor_wrapper"))[0],o.options.toolsObj.arrow=t.element(document.querySelector("#arrow"))[0],o.options.toolsObj.line=t.element(document.querySelector("#line"))[0],o.options.toolsObj.imageupload=t.element(document.querySelector("#imageupload"))[0],o.options.toolsObj.clear_image=t.element(document.querySelector("#clear_image"))[0],o.options.toolsObj.frm_canvas_tool=t.element(document.querySelector("#frm_canvas_tool"))[0],o.options.toolsObj.undo=t.element(document.querySelector("#undo"))[0],o.options.toolsObj.redo=t.element(document.querySelector("#redo"))[0],o.options.toolsObj.save=t.element(document.querySelector("#save"))[0],o.options.toolsObj.fontsize=t.element(document.querySelector("#fontsize"))[0],o.options.toolsObj.fillstyle=t.element(document.querySelector("#fillstyle"))[0],o.options.toolsObj.linewidth=t.element(document.querySelector("#linewidth"))[0],o.options.toolsObj.prevBtn=t.element(document.querySelector("#prevBtn"))[0],o.options.toolsObj.nextBtn=t.element(document.querySelector("#nextBtn"))[0],o.options.toolsObj.activePage=t.element(document.querySelector("#activePage"))[0],o.options.toolsObj.currentPage=t.element(document.querySelector("#currentPage"))[0],o.options.toolsObj.totalPage=t.element(document.querySelector("#totalPage"))[0],o.options.toolsObj.canvas=t.element(document.querySelector("#canvas"))[0],o.options.toolsObj.close=t.element(document.querySelector("#close"))[0],o.options.toolsObj.canvasContainer=t.element(document.querySelector("#canvas-container"))[0],o.options.toolsObj.close.addEventListener("click",function(){o.event.options.activeTool="",o.history.manageActiveBtn(""),o.event.closepdf()}),i.$watch("options",function(t,s){""!==i.options.url?(o.history.initial_canvas_url=[],o.history.final_canvas_url=[],o.history.final_canvas_url=[],o.history.redo_list=[],o.history.undo_list=[],o.history.raw_undo_list=[],o.history.raw_redo_list=[],o.history.raw_undo_ver_list=[],o.history.raw_redo_ver_list=[],o.history.tmp_raw_undo_list="",o.history.options.activePage=0,o.history.manageActiveBtn(""),o.history.setButtonStyle(),o.options.toolsObj.canvasContainer.innerHTML="",o.options.bindFlag="",o.options.btnFlag=!1,o.options.bindCnt=0,i.options.pdfworker&&(o.options.pdfWorker=i.options.pdfworker),i.errorURL=!1,o.renderPDF(i.options.url,o.options.toolsObj.canvasContainer)):i.errorURL=!0})}}}])}),$(window).scroll(function(){var t=90,o=$(window).scrollTop();o>t?$("#controllers").css({position:"fixed"}):$("#controllers").css({position:"relative"})});