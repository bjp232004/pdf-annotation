"use strict";!function(t,o){return"function"==typeof define&&define.amd?void define("pdf-annotation",["angular"],function(t){return o(t)}):o(t)}("undefined"==typeof angular?null:angular,function(t){var o=t.module("pdfAnnotation",[]);o.directive("pdfAnnotation",function(o){return{restrict:"E",scope:{options:"=",callbackFn:"&",closeFn:"&"},transclude:!0,templateUrl:'<div id="controllers">\n                            <a href="#" id="close" ng-show="options.enableCloseBtn" class="close">&nbsp;</a>\n                            <span class="controller btn btn-icn" id="pencil" title="Freehand Drawing"></span>\n                            <span class="controller btn btn-icn" id="square" title="Square"></span>\n                            <span class="controller btn btn-icn" id="circle" title="Circle"></span>\n                            <span class="controller btn btn-icn" id="ellipse" title="Ellipse"></span>\n                            <span class="controller btn btn-icn" id="text" title="Text"></span>\n                            <span class="controller btn btn-icn" id="arrow" title="Arrow"></span>\n                            <span class="controller btn btn-icn" id="line" title="Line"></span>\n                            <span class="controller btn btn-icn" id="undo" title="Undo"></span>\n                            <span class="controller btn btn-icn" id="redo" title="Redo"></span>\n                            <span class="controller title" id="activePage" disabled="disabled"></span>&nbsp; out of&nbsp;<span class="controller title" id="totalPage" disabled="disabled"></span>\n                            <span class="controller btn" id="prevBtn"><</span> &nbsp;<input type="text" class="pagenumber" name="currentPage" id="currentPage" />&nbsp;<span class="controller btn" id="nextBtn">></span>\n                            <span class="controller btn btn-icn" id="save" title="Save"></span>\n                            <br /><br />\n                            <form id="frm_canvas_tool">\n                                <input name="imageupload" id="imageupload" class="input_file" type="file" accept="image/*" >\n                                <span class="controller btn" id="clear_image">Clear Image</span>\n                            </form>\n                            Font Size: <select id="fontsize" name="fontsize">\n                            <option value="">-- Select Font Size--</option>\n                            <option value="2">2px</option>\n                            <option value="5">5px</option>\n                            <option value="7">7px</option>\n                            <option value="8">8px</option>\n                            <option value="9">9px</option>\n                            <option value="10">10px</option>\n                            <option value="11">11px</option>\n                            <option value="12">12px</option>\n                            <option value="13">13px</option>\n                            <option value="14">14px</option>\n                            <option value="16">16px</option>\n                            <option value="18">18px</option>\n                            <option value="32">32px</option>\n                        </select>\n                            Color: <select id="fillstyle" name="fillstyle">\n                            <option>--Select Color--</option>\n                            <option value="FF0000">Red</option>\n                            <option value="00FF00">Green</option>\n                            <option value="0000FF">Blue</option>\n                            <option value="000000">Black</option>\n                            <option value="FFFFFF">White</option>\n                        </select>\n                            Line Width: <select id="linewidth" name="linewidth">\n                            <option value="">-- Select Font Size--</option>\n                            <option value="2">2px</option>\n                            <option value="5">5px</option>\n                            <option value="7">7px</option>\n                            <option value="8">8px</option>\n                        </select>\n                            <span class="controller" id="loading"></span>\n                        </div>\n                        <div id="canvas-container" class="canvas-container" style="visibility: hidden; height: 0px;">\n                        </div>\n                        <div id="canvas-cont" class="canvas-container">\n                            <canvas id="canvas"></canvas>\n                            <div id="editor_wrapper" style="display:none;">\n                                <textarea id="contenteditor" rows="10"></textarea>\n                            </div>\n\n                        </div>\n                        <div ng-if="errorURL"><h1>URL not found!</h1></div>',link:function(i,s,n,e){o.options.closeFn=i.closeFn,o.options.callbackFn=i.callbackFn,o.options.toolsObj.loading=t.element(document.querySelector("#loading"))[0],o.options.toolsObj.pencil=t.element(document.querySelector("#pencil"))[0],o.options.toolsObj.square=t.element(document.querySelector("#square"))[0],o.options.toolsObj.circle=t.element(document.querySelector("#circle"))[0],o.options.toolsObj.ellipse=t.element(document.querySelector("#ellipse"))[0],o.options.toolsObj.text=t.element(document.querySelector("#text"))[0],o.options.toolsObj.contenteditor=t.element(document.querySelector("#contenteditor"))[0],o.options.toolsObj.editor_wrapper=t.element(document.querySelector("#editor_wrapper"))[0],o.options.toolsObj.arrow=t.element(document.querySelector("#arrow"))[0],o.options.toolsObj.line=t.element(document.querySelector("#line"))[0],o.options.toolsObj.imageupload=t.element(document.querySelector("#imageupload"))[0],o.options.toolsObj.clear_image=t.element(document.querySelector("#clear_image"))[0],o.options.toolsObj.frm_canvas_tool=t.element(document.querySelector("#frm_canvas_tool"))[0],o.options.toolsObj.undo=t.element(document.querySelector("#undo"))[0],o.options.toolsObj.redo=t.element(document.querySelector("#redo"))[0],o.options.toolsObj.save=t.element(document.querySelector("#save"))[0],o.options.toolsObj.fontsize=t.element(document.querySelector("#fontsize"))[0],o.options.toolsObj.fillstyle=t.element(document.querySelector("#fillstyle"))[0],o.options.toolsObj.linewidth=t.element(document.querySelector("#linewidth"))[0],o.options.toolsObj.prevBtn=t.element(document.querySelector("#prevBtn"))[0],o.options.toolsObj.nextBtn=t.element(document.querySelector("#nextBtn"))[0],o.options.toolsObj.activePage=t.element(document.querySelector("#activePage"))[0],o.options.toolsObj.currentPage=t.element(document.querySelector("#currentPage"))[0],o.options.toolsObj.totalPage=t.element(document.querySelector("#totalPage"))[0],o.options.toolsObj.canvas=t.element(document.querySelector("#canvas"))[0],o.options.toolsObj.close=t.element(document.querySelector("#close"))[0],o.options.toolsObj.canvasContainer=t.element(document.querySelector("#canvas-container"))[0],o.options.toolsObj.close.addEventListener("click",function(){o.event.options.activeTool="",o.history.manageActiveBtn(""),o.event.closepdf()}),i.$watch("options",function(t,s){""!==i.options.url?(o.history.initial_canvas_url=[],o.history.final_canvas_url=[],o.history.final_canvas_url=[],o.history.redo_list=[],o.history.undo_list=[],o.history.raw_undo_list=[],o.history.raw_redo_list=[],o.history.raw_undo_ver_list=[],o.history.raw_redo_ver_list=[],o.history.tmp_raw_undo_list="",o.history.options.activePage=0,o.history.manageActiveBtn(""),o.history.setButtonStyle(),o.options.toolsObj.canvasContainer.innerHTML="",o.options.bindFlag="",o.options.btnFlag=!1,o.options.bindCnt=0,i.errorURL=!1,o.renderPDF(i.options.url,o.options.toolsObj.canvasContainer)):i.errorURL=!0})}}}),o.factory("pdfAnnotationFactory",function(){var o={};return o.options={viewport:"",canvas_rand:"",ctx_rand:"",renderContext:{canvasContext:"",viewport:""},bindFlag:"",btnFlag:!1,bindCnt:0,pdfOptions:{},toolsObj:{},optionArrData:{startX:[],startY:[],endX:[],endY:[],pencilData:[]}},o.history={options:{canvas_width:"",canvas_height:"",activePage:0,totalPage:1,enablePrevBtn:!1,enableNextBtn:!1,font_size:18,fillStyle:"FF0000",lineWidth:2,undoFlag:!1,redoFlag:!1,arrData:{startX:[],startY:[],endX:[],endY:[],pencilData:[]}},initial_canvas_url:[],final_canvas_url:[],redo_list:[],undo_list:[],raw_undo_list:[],raw_redo_list:[],raw_undo_ver_list:[],raw_redo_ver_list:[],tmp_raw_undo_list:"",setStyleElement:function(t,o){o.fillStyle="#"+this.options.fillStyle.replace("#",""),o.font=this.options.font_size+"px Calibri",o.lineWidth=this.options.lineWidth,o.strokeStyle="#"+this.options.fillStyle.replace("#","")},resetStyleElement:function(){this.options.fillStyle=document.getElementById("fillstyle").value,this.options.font_size=document.getElementById("fontsize").value,this.options.lineWidth=document.getElementById("linewidth").value},setButtonStyle:function(){this.raw_undo_ver_list.length>0?(this.raw_undo_ver_list[this.options.activePage].length>0||this.raw_undo_list[this.options.activePage].length>0?o.options.toolsObj.undo.classList.remove("cur_disable"):o.options.toolsObj.undo.className+=" cur_disable",this.raw_redo_ver_list[this.options.activePage].length>0?o.options.toolsObj.redo.classList.remove("cur_disable"):o.options.toolsObj.redo.className+=" cur_disable"):(o.options.toolsObj.undo.className+=" cur_disable",o.options.toolsObj.redo.className+=" cur_disable")},saveState:function(i,s,n){n=n||!1,n||(this.redo_list=[]),this.undo_list.hasOwnProperty(this.options.activePage)||(this.undo_list[this.options.activePage]=[]),this.raw_undo_list.hasOwnProperty(this.options.activePage)||(this.raw_undo_list[this.options.activePage]=[],this.raw_redo_list[this.options.activePage]=[],this.raw_undo_ver_list[this.options.activePage]=[],this.raw_redo_ver_list[this.options.activePage]=[]);var e=i.toDataURL();if(s)s.hasOwnProperty(this.options.activePage)||(s[this.options.activePage]=[]),s[this.options.activePage][0]=e;else if(this.undo_list[this.options.activePage][0]=e,o.event.options.activeTool&&"move"!==o.event.options.activeTool.name)this.saveRawData();else if(""!=this.tmp_raw_undo_list){var a=t.copy(this.tmp_raw_undo_list);this.tmp_raw_undo_list="",this.raw_undo_ver_list[this.options.activePage].push(a)}this.setButtonStyle(),o.history.final_canvas_url[o.history.options.PrevPage]=e},saveRawData:function(){if(!o.event.options.activeTool.drawing){if(this.raw_undo_list.hasOwnProperty(this.options.activePage)||(this.raw_undo_list[this.options.activePage]=[],this.raw_redo_list[this.options.activePage]=[],this.raw_undo_ver_list[this.options.activePage]=[],this.raw_redo_ver_list[this.options.activePage]=[]),this.raw_undo_list[this.options.activePage].length>0){var i=t.copy(this.raw_undo_list[this.options.activePage]);this.raw_undo_ver_list[this.options.activePage].push(i)}var s=t.copy(this.options.arrData);s.name&&""!=s.name&&(this.raw_undo_list[this.options.activePage][this.raw_undo_list[this.options.activePage].length]=s,this.options.undoFlag=!0),o.options.optionArrData=this.options.arrData={startX:[],startY:[],endX:[],endY:[],pencilData:[]}}},setRawData:function(){o.options.optionArrData.name=o.event.options.activeTool.name,o.options.optionArrData.startX.push(o.event.options.activeTool.options.startX),o.options.optionArrData.startY.push(o.event.options.activeTool.options.startY),o.options.optionArrData.endX.push(o.event.options.activeTool.options.endX),o.options.optionArrData.endY.push(o.event.options.activeTool.options.endY),o.options.optionArrData.font_size=this.options.font_size,o.options.optionArrData.fillStyle=this.options.fillStyle,o.options.optionArrData.lineWidth=this.options.lineWidth,"text"===o.options.optionArrData.name&&(o.options.optionArrData.textInfo=o.event.options.activeTool.options.textInfo,o.options.optionArrData.finalTextInfo=o.event.options.activeTool.options.finalTextInfo),"image"===o.options.optionArrData.name&&(o.options.optionArrData.imageURL=o.event.options.activeTool.options.uploadedImage[o.event.options.activeTool.options.uploadedImage.length-1]),"circle"===o.options.optionArrData.name&&(o.options.optionArrData.radius=o.event.options.activeTool.options.radius),"pencil"===o.options.optionArrData.name&&o.options.optionArrData.pencilData.push({x:o.event.options.activeTool.options.startX,y:o.event.options.activeTool.options.startY}),"line"===o.options.optionArrData.name&&(o.options.optionArrData.lineAngle=Math.atan2(o.event.options.activeTool.options.endY-o.event.options.activeTool.options.startY,o.event.options.activeTool.options.endX-o.event.options.activeTool.options.startX)),"arrow"===o.options.optionArrData.name&&(o.options.optionArrData.arrowAngle=Math.atan2(o.event.options.activeTool.options.endY-o.event.options.activeTool.options.startY,o.event.options.activeTool.options.endX-o.event.options.activeTool.options.startX)),this.options.arrData=t.copy(o.options.optionArrData)},undo:function(t,o){this.options.action="undo",this.restoreStateRawData(this.raw_undo_list,this.raw_redo_list),this.redrawState(t,o)},redo:function(t,i){this.options.action="redo",this.restoreStateRawData(this.raw_undo_list,this.raw_redo_list),o.move.init(t,i),this.redrawState(t,i)},restoreState:function(t,i,s,n){var e=s[this.options.activePage];if(e.length){if(n&&"undo"==this.options.action&&this.saveState(t,n,!0),"undo"==this.options.action){var a=e.pop();if(e.length)var r=e[e.length-1];else var r=a}else{var a=e.pop(),r=a;this.undo_list[this.options.activePage].push(a)}var h=document.createElement("img");h.src=r,h.onload=function(){i.clearRect(0,0,o.history.options.canvas_width,o.history.options.canvas_height),i.drawImage(h,0,0,o.history.options.canvas_width,o.history.options.canvas_height)}}},restoreStateRawData:function(o,i){var s=o[this.options.activePage];if("undo"==this.options.action){if(this.raw_undo_ver_list[this.options.activePage].length>0){var n=t.copy(s);if(this.raw_redo_ver_list[this.options.activePage].push(n),this.options.redoFlag=!0,this.raw_undo_ver_list[this.options.activePage].length>0){var e=t.copy(this.raw_undo_ver_list[this.options.activePage].pop());this.raw_undo_list[this.options.activePage]=e}}else if(1==this.options.undoFlag){var n=t.copy(s);this.raw_redo_ver_list[this.options.activePage].push(n),this.raw_undo_list[this.options.activePage]=[],this.options.undoFlag=!1}this.setButtonStyle()}else{if(this.raw_redo_ver_list[this.options.activePage].length>0){if(this.raw_undo_list[this.options.activePage].length>0){var n=t.copy(this.raw_undo_list[this.options.activePage]);this.raw_undo_ver_list[this.options.activePage].push(n)}if(this.options.undoFlag=!0,this.raw_redo_ver_list[this.options.activePage].length>0){var a=t.copy(this.raw_redo_ver_list[this.options.activePage].pop()),r=a;this.raw_undo_list[this.options.activePage]=r}}else if(1==this.options.redoFlag){var a=t.copy(this.raw_redo_ver_list[this.options.activePage].pop()),r=a;this.raw_undo_list[this.options.activePage]=r,this.options.redoFlag=!1}this.setButtonStyle()}},drawingState:function(t,i,s){if(s[this.options.activePage].length){var n=s[this.options.activePage][s[this.options.activePage].length-1],e=document.createElement("img");e.src=n,e.onload=function(){i.clearRect(0,0,o.history.options.canvas_width,o.history.options.canvas_height),i.drawImage(e,0,0,o.history.options.canvas_width,o.history.options.canvas_height),o.event.options.activeTool.drawTool()}}},redrawState:function(t,i){if(this.initial_canvas_url[this.options.activePage]){var s=this.initial_canvas_url[this.options.activePage],n=document.createElement("img");n.src=s,n.onload=function(){i.clearRect(0,0,o.history.options.canvas_width,o.history.options.canvas_height),i.drawImage(n,0,0,o.history.options.canvas_width,o.history.options.canvas_height),o.history.raw_undo_list[o.history.options.activePage].length>0&&o.move.redrawTool()}}},manageActiveBtn:function(t){for(var i=document.getElementsByClassName("controller active"),s=0;s<i.length;s++)i[s].classList.remove("active");""!==t&&(document.getElementById(t).className+=" active","clear_image"!==t&&o.options.toolsObj.frm_canvas_tool.reset())}},o.event={options:{activeTool:""},init:function(t,o){this.canvas=t,this.canvas_coords=this.canvas.getBoundingClientRect(),this.ctx=o,this.ctx.strokeColor=this.options.stroke_color,this.paging(),this.addCanvasEvents()},addCanvasEvents:function(){this.canvas.addEventListener("mousedown",this.start.bind(this)),this.canvas.addEventListener("mousemove",this.stroke.bind(this)),this.canvas.addEventListener("mouseup",this.stop.bind(this)),this.canvas.addEventListener("mouseout",this.stop.bind(this))},start:function(t){o.history.raw_undo_list[o.history.options.activePage].length>0&&(o.move.init(this.canvas,this.ctx),o.move.start(t)),o.move.options.movedObject==-1&&""!==this.options.activeTool&&void 0!==this.options.activeTool&&this.options.activeTool.start(t)},stroke:function(t){""!==this.options.activeTool&&void 0!==this.options.activeTool&&this.options.activeTool.drawing===!0&&this.options.activeTool.stroke(t)},stop:function(t){""!==this.options.activeTool&&void 0!==this.options.activeTool&&this.options.activeTool.drawing===!0&&this.options.activeTool.stop(t)},closepdf:function(){o.options.closeFn()},savepdf:function(){var t=confirm("Are you sure to you want to save file?");if(t){var s=new jsPDF("p","mm","a4");for(i=0;i<parseInt(o.history.options.totalPage);i++)if(i<2){if(o.history.final_canvas_url.hasOwnProperty(i))var n=o.history.final_canvas_url[i];else var n=document.getElementById("page"+i).toDataURL("image/png");s.addImage(n,"PNG",0,0,200,250),i<parseInt(o.history.options.totalPage-1)&&s.addPage()}var e=s.output("datauristring"),a=this.dataURLtoBlob(e);"function"==typeof o.options.callbackFn?o.options.callbackFn({blob:a}):s.save()}},dataURLtoBlob:function(t){for(var o=t.split(","),i=o[0].match(/:(.*?);/)[1],s=atob(o[1]),n=s.length,e=new Uint8Array(n);n--;)e[n]=s.charCodeAt(n);return new Blob([e],{type:i})},paging:function(){o.history.options.totalPage=o.history.options.pdfobj.transport.numPages,o.options.toolsObj.activePage.textContent=o.history.options.activePage+1,o.options.toolsObj.currentPage.value=o.history.options.activePage+1,o.options.toolsObj.totalPage.textContent=o.history.options.totalPage,0===o.history.options.activePage?(o.options.toolsObj.prevBtn.setAttribute("disabled","disabled"),o.options.toolsObj.nextBtn.removeAttribute("disabled")):parseInt(o.history.options.activePage)===parseInt(o.history.options.totalPage-1)?(o.options.toolsObj.nextBtn.setAttribute("disabled","disabled"),o.options.toolsObj.prevBtn.removeAttribute("disabled")):o.history.options.activePage>0&&parseInt(o.history.options.activePage)<parseInt(o.history.options.totalPage-1)&&(o.options.toolsObj.prevBtn.removeAttribute("disabled"),o.options.toolsObj.nextBtn.removeAttribute("disabled"))}},o.text={name:"text",options:{stroke_color:["00","00","00"],fill_color:"#FF0000",font:"18px Arial",dim:4,lineHeight:14,finalTextInfo:[]},init:function(t,o){this.canvas=t,this.ctx=o,this.ctx.strokeColor=this.options.stroke_color,this.ctx.fillStyle="rgba(0,0,0,0)",this.drawing=!1,this.options.flag=!0},start:function(t){if(this.options.flag){this.canvas_coords=this.canvas.getBoundingClientRect();var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.startX=o,this.options.startY=i,this.options.endX=o,this.options.endY=i,this.ctx.fillStyle=this.options.fill_color,this.ctx.font=this.options.font,this.ctx.beginPath(),this.drawing=!0}},stroke:function(t){if(this.options.flag&&this.drawing){var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.endX=o,this.options.endY=i}},stop:function(t){this.drawing&&this.options.flag&&this.options.startX!==this.options.endX&&this.options.startY!==this.options.endY?(this.drawing=!1,this.options.flag=!1,this.options.lineHeight=parseInt(o.history.options.font_size),o.options.toolsObj.editor_wrapper.style.display="block",o.options.toolsObj.editor_wrapper.style.top=this.options.startY+this.canvas_coords.top-10,o.options.toolsObj.editor_wrapper.style.left=this.options.startX+this.canvas_coords.left,o.options.toolsObj.editor_wrapper.style.width=this.options.endX-this.options.startX,o.options.toolsObj.contenteditor.focus(),o.options.toolsObj.contenteditor.style.minHeight=parseInt(this.options.endY-this.options.startY)):(this.ctx.closePath(),this.ctx.stroke(),this.drawing=!1)},drawTool:function(){o.history.setStyleElement(this.canvas,this.ctx),o.options.toolsObj.contenteditor.style.fontSize=o.history.options.font_size,o.options.toolsObj.contenteditor.style.lineHeight=o.history.options.font_size+"px",o.options.toolsObj.contenteditor.style.height=o.options.toolsObj.contenteditor.scrollHeight+"px";var t=o.options.toolsObj.contenteditor.value,i=escape(t);if(t=unescape(i.replace(/%0A/g,"<br />").replace(/%20/g," ")),o.options.toolsObj.contenteditor.value="",""!==t){var s={text:t,x:this.options.startX,y:this.options.startY,boxWidth:this.options.endX-this.options.startX};this.drawStyledText(s),this.options.flag=!0}},drawStyledText:function(t){this.options.textInfo=t;var i,s,n,e,a,r,h=t.text,p=t.x,c=t.y,l=[],d=t.boxWidth,v=h.match(/<\s*br\s*\/>|<\s*class=["|']([^"|']+)["|']\s*\>([^>]+)<\s*\/class\s*\>|<\s*style=["|']([^"|']+)["|']\s*\>([^>]+)<\s*\/style\s*\>|[^<]+/g);for(r=0;r<v.length;r++)if(/<\s*br\s*\/>/i.test(v[r]))c+=1.5*parseInt(this.options.lineHeight,10),p=t.x;else{if(n=v[r],l=[],n=n.replace(/\s*\n\s*/g," "),void 0!==d&&this.checkLineBreak(n,d+t.x,p))if(i=this.trim(n).split(" "),1==i.length)l.push({text:this.trim(n)+" ",linebreak:!0});else{s=p;var u=0;for(l[u]={text:void 0,linebreak:!1},e=0;e<i.length;e++)i[e]+=" ",this.checkLineBreak(i[e],d+t.x,s)?(s=t.x,void 0!==l[u].text&&u++,l[u]={text:i[e],linebreak:!0},s+=this.ctx.measureText(i[e]).width):(void 0==l[u].text?l[u].text=i[e]:l[u].text+=i[e],s+=this.ctx.measureText(i[e]).width)}for(0==l.length&&l.push({text:this.trim(n)+" ",linebreak:!1}),a=0;a<l.length;a++)l[a].linebreak&&(c+=parseInt(this.options.lineHeight,10),p=t.x,this.options.endY=c),this.ctx.fillText(l[a].text,p,c),this.options.finalTextInfo.push({text:l[a].text,x:p,y:c}),p+=this.ctx.measureText(l[a].text).width}o.square.canvas=this.canvas,o.square.ctx=this.ctx,o.square.options.startX=this.options.startX-10,o.square.options.startY=this.options.startY-15,o.square.options.endX=this.options.endX,o.square.options.endY=this.options.endY+10,o.square.drawTool(),this.ctx.stroke(),o.history.setRawData(),o.history.saveState(this.canvas)},redrawTool:function(t,i,s){for(var n=0;n<t.length;n++)this.ctx.fillText(t[n].text,t[n].x+i,t[n].y+s);o.square.canvas=this.canvas,o.square.ctx=this.ctx,o.square.options.startX=this.options.startX-10,o.square.options.startY=this.options.startY-15,o.square.options.endX=this.options.endX,o.square.options.endY=this.options.endY+10,o.square.drawTool()},checkLineBreak:function(t,o,i){return this.ctx.measureText(t).width+i>o},trim:function(t){var o,i;for(t=t.replace(/^\s\s*/,""),o=/\s/,i=t.length;o.test(t.charAt(--i)););return t.slice(0,i+1)}},o.image={name:"image",options:{activeImage:"",uploadedImage:[],width:"",height:"",wdthHghtRatio:"",img:""},init:function(t,o){this.canvas=t,this.ctx=o,this.ctx.strokeColor=this.options.stroke_color,this.drawing=!1},start:function(t){this.canvas_coords=this.canvas.getBoundingClientRect();var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.startX=o,this.options.startY=i,this.options.endX=o,this.options.endY=i,this.ctx.beginPath(),this.drawing=!0},stroke:function(t){if(this.drawing){o.history.drawingState(this.canvas,this.ctx,o.history.undo_list);var i=t.pageX-this.canvas_coords.left,s=t.pageY-this.canvas_coords.top;this.options.endX=i,this.options.endY=s,this.drawTool()}},stop:function(t){this.drawing&&this.options.startX!==this.options.endX&&this.options.startY!==this.options.endY?(this.ctx.beginPath(),this.drawTool(),this.ctx.closePath(),this.ctx.stroke(),this.drawing=!1,o.history.setRawData(),o.history.saveState(this.canvas)):(this.ctx.closePath(),this.ctx.stroke(),this.drawing=!1)},drawTool:function(){this.ctx.beginPath(),o.history.setStyleElement(this.canvas,this.ctx),this.options.width=parseInt(this.options.endX-this.options.startX),this.options.height=parseInt(this.options.endY-this.options.startY),this.ctx.drawImage(this.options.img,this.options.startX,this.options.startY,this.options.width,this.options.height)},uploadImage:function(t){var o=new Image;o.onload=function(t){},o.src=URL.createObjectURL(t),this.options.uploadedImage.push(URL.createObjectURL(t)),this.options.img=o}},o.arrow={name:"arrow",options:{stroke_color:["00","00","00"],dim:4,arrow:{h:5,w:10},headlen:10},init:function(t,o){this.canvas=t,this.ctx=o,this.ctx.strokeColor=this.options.stroke_color,this.ctx.fillStyle="rgba(0,0,0,0)",this.drawing=!1},start:function(t){this.canvas_coords=this.canvas.getBoundingClientRect();var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.startX=o,this.options.startY=i,this.options.endX=o,this.options.endY=i,this.ctx.beginPath(),this.drawing=!0},stroke:function(t){if(this.drawing){o.history.drawingState(this.canvas,this.ctx,o.history.undo_list);var i=t.pageX-this.canvas_coords.left,s=t.pageY-this.canvas_coords.top;this.options.endX=i,this.options.endY=s,this.drawTool()}},stop:function(t){this.drawing&&this.options.startX!==this.options.endX&&this.options.startY!==this.options.endY?(this.ctx.beginPath(),this.drawTool(),this.ctx.closePath(),this.ctx.stroke(),this.drawing=!1,o.history.setRawData(),o.history.saveState(this.canvas)):(this.ctx.closePath(),this.ctx.stroke(),this.drawing=!1)},drawTool:function(){this.ctx.beginPath(),o.history.setStyleElement(this.canvas,this.ctx);var t=Math.atan2(this.options.endY-this.options.startY,this.options.endX-this.options.startX);this.ctx.moveTo(this.options.startX,this.options.startY),this.ctx.lineTo(this.options.endX,this.options.endY),this.ctx.lineTo(this.options.endX-this.options.headlen*Math.cos(t-Math.PI/6),this.options.endY-this.options.headlen*Math.sin(t-Math.PI/6)),this.ctx.moveTo(this.options.endX,this.options.endY),this.ctx.lineTo(this.options.endX-this.options.headlen*Math.cos(t+Math.PI/6),this.options.endY-this.options.headlen*Math.sin(t+Math.PI/6)),this.ctx.stroke()}},o.line={name:"line",options:{stroke_color:["00","00","00"],dim:4},init:function(t,o){this.canvas=t,this.ctx=o,this.ctx.strokeColor=this.options.stroke_color,this.ctx.fillStyle="rgba(0,0,0,0)",this.drawing=!1},start:function(t){this.canvas_coords=this.canvas.getBoundingClientRect();var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.startX=o,this.options.startY=i,this.options.endX=o,this.options.endY=i,this.ctx.beginPath(),this.drawing=!0},stroke:function(t){if(this.drawing){o.history.drawingState(this.canvas,this.ctx,o.history.undo_list);var i=t.pageX-this.canvas_coords.left,s=t.pageY-this.canvas_coords.top;this.options.endX=i,this.options.endY=s,this.drawTool()}},stop:function(t){this.drawing&&this.options.startX!==this.options.endX&&this.options.startY!==this.options.endY?(this.ctx.beginPath(),this.drawTool(),this.ctx.closePath(),this.ctx.stroke(),this.drawing=!1,o.history.setRawData(),o.history.saveState(this.canvas)):(this.ctx.closePath(),this.ctx.stroke(),this.drawing=!1)},drawTool:function(){this.ctx.beginPath(),o.history.setStyleElement(this.canvas,this.ctx);Math.atan2(this.options.endY-this.options.startY,this.options.endX-this.options.startX);this.ctx.moveTo(this.options.startX,this.options.startY),this.ctx.lineTo(this.options.endX,this.options.endY),this.ctx.stroke()},redrawTool:function(){this.ctx.beginPath(),o.history.setStyleElement(this.canvas,this.ctx);Math.atan2(this.options.endY-this.options.startY,this.options.endX-this.options.startX);this.ctx.moveTo(this.options.startX,this.options.startY),this.ctx.lineTo(this.options.endX,this.options.endY),this.ctx.stroke()}},o.circle={name:"circle",options:{stroke_color:["00","00","00"],dim:4},init:function(t,o){this.canvas=t,this.ctx=o,this.ctx.strokeColor=this.options.stroke_color,this.ctx.fillStyle="rgba(0,0,0,0)",this.drawing=!1},start:function(t){this.canvas_coords=this.canvas.getBoundingClientRect();var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.startX=o,this.options.startY=i,this.options.endX=o,this.options.endY=i,this.ctx.beginPath(),this.drawing=!0},stroke:function(t){if(this.drawing){var i=t.pageX-this.canvas_coords.left,s=t.pageY-this.canvas_coords.top;this.options.endX=i,this.options.endY=s,o.history.drawingState(this.canvas,this.ctx,o.history.undo_list)}},stop:function(t){this.drawing&&this.options.startX!==this.options.endX&&this.options.startY!==this.options.endY?(this.drawTool(),this.ctx.closePath(),this.ctx.stroke(),this.drawing=!1,o.history.setRawData(),o.history.saveState(this.canvas)):(this.ctx.closePath(),this.ctx.stroke(),this.drawing=!1)},drawTool:function(){if(this.drawing){o.history.setStyleElement(this.canvas,this.ctx);var t=parseInt(this.options.endX-this.options.startX),i=parseInt(this.options.endY-this.options.startY),s=t+i,n=2*Math.PI/s;this.options.radius=s,this.ctx.beginPath();for(var e=0;e<2*Math.PI;e+=n){var a=t+s*Math.cos(e),r=i-s*Math.sin(e);this.ctx.lineTo(a+this.options.startX,r+this.options.startY)}this.ctx.stroke()}}},o.ellipse={name:"ellipse",options:{stroke_color:["00","00","00"],dim:4},init:function(t,o){this.canvas=t,this.ctx=o,this.ctx.strokeColor=this.options.stroke_color,this.ctx.fillStyle="rgba(0,0,0,0)",this.drawing=!1},start:function(t){this.canvas_coords=this.canvas.getBoundingClientRect();var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.startX=o,this.options.startY=i,this.options.endX=o,this.options.endY=i,this.ctx.beginPath(),this.drawing=!0},stroke:function(t){if(this.drawing){var i=t.pageX-this.canvas_coords.left,s=t.pageY-this.canvas_coords.top;this.options.endX=i,this.options.endY=s,o.history.drawingState(this.canvas,this.ctx,o.history.undo_list)}},stop:function(t){this.drawing&&this.options.startX!==this.options.endX&&this.options.startY!==this.options.endY?(this.drawTool(),this.ctx.closePath(),this.ctx.stroke(),this.drawing=!1,o.history.setRawData(),o.history.saveState(this.canvas)):(this.ctx.closePath(),this.ctx.stroke(),this.drawing=!1)},drawTool:function(){if(this.drawing){for(o.history.setStyleElement(this.canvas,this.ctx),this.ctx.beginPath(),m=0*Math.PI;m<2*Math.PI;m+=.01)xPos=this.options.startX-parseInt(this.options.endX-this.options.startX)*Math.cos(m),yPos=this.options.startY+parseInt(this.options.endY-this.options.startY)*Math.sin(m),0==m?this.ctx.moveTo(xPos,yPos):this.ctx.lineTo(xPos,yPos);this.ctx.stroke()}}},o.pencil={name:"pencil",options:{stroke_color:["00","00","00"],dim:4},init:function(t,o){this.canvas=t,this.ctx=o,this.ctx.strokeColor=this.options.fillStyle,this.drawing=!1},start:function(t){o.history.setStyleElement(this.canvas,this.ctx),this.canvas_coords=this.canvas.getBoundingClientRect();var i=t.pageX-this.canvas_coords.left,s=t.pageY-this.canvas_coords.top;this.options.startX=i,this.options.startY=s,this.options.endX=0,this.options.endY=0,this.ctx.beginPath(),this.ctx.moveTo(this.options.startX,this.options.startY),o.history.setRawData(),this.drawing=!0},stroke:function(t){if(this.drawing){var i=t.pageX-this.canvas_coords.left,s=t.pageY-this.canvas_coords.top;this.options.startX=i,this.options.startY=s,this.options.endX=0,this.options.endY=0,this.ctx.lineTo(this.options.startX,this.options.startY),o.history.setRawData(),this.ctx.stroke()}},stop:function(t){this.drawing&&(this.drawing=!1,o.history.saveState(this.canvas))},drawTool:function(){},redrawTool:function(){this.ctx.beginPath();for(var t=0;t<this.options.pencilData.length;t++)0==t?this.ctx.moveTo(this.options.pencilData[t].x+this.options.diffX,this.options.pencilData[t].y+this.options.diffY):this.ctx.lineTo(this.options.pencilData[t].x+this.options.diffX,this.options.pencilData[t].y+this.options.diffY);
this.ctx.stroke()}},o.move={name:"move",options:{arrTool:["square","circle","text","image","line","arrow","ellipse"],prevTool:"",movedObject:-1,cursorStyle:"move",isResize:!1,arrResize:{startX:!1,startY:!1,endX:!1,endY:!1},resizeMargin:10},init:function(t,o){this.canvas=t,this.canvas_coords=this.canvas.getBoundingClientRect(),this.ctx=o,this.drawing=!1},start:function(t){var i=t.pageX-this.canvas_coords.left,s=t.pageY-this.canvas_coords.top;return this.options.startX=i,this.options.startY=s,this.options.startDiffX=t.pageX,this.options.startDiffY=t.pageY,this.options.cursorStyle="move",this.hitTest(),!(this.options.movedObject>=0)||(this.options.prevTool=o.event.options.activeTool,o.event.options.activeTool=o.move,o.options.toolsObj.canvas.style.cursor=this.options.cursorStyle,void(this.drawing=!0))},stroke:function(t){if(this.drawing){var i=t.pageX-this.canvas_coords.left,s=t.pageY-this.canvas_coords.top;this.options.endX=i,this.options.endY=s,this.options.endDiffX=t.pageX,this.options.endDiffY=t.pageY,this.options.diffX=this.options.endDiffX-this.options.startDiffX,this.options.diffY=this.options.endDiffY-this.options.startDiffY,o.history.redrawState(this.canvas,this.ctx)}},stop:function(i){if(this.drawing){if(this.drawing=!1,this.options.movedObject>=0)if(o.history.tmp_raw_undo_list=t.copy(o.history.raw_undo_list[o.history.options.activePage]),this.options.arrTool.indexOf(o.history.options.arrData.name)>-1){if(this.options.isResize===!1?(o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].startX[0]=o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].startX[0]+this.options.diffX,o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].startY[0]=o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].startY[0]+this.options.diffY,o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].endX[0]=o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].endX[0]+this.options.diffX,o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].endY[0]=o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].endY[0]+this.options.diffY):(this.options.arrResize.startX===!0&&(o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].startX[0]=o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].startX[0]+this.options.diffX),this.options.arrResize.startY===!0&&(o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].startY[0]=o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].startY[0]+this.options.diffY),this.options.arrResize.endX===!0&&(o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].endX[0]=o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].endX[0]+this.options.diffX),this.options.arrResize.endY===!0&&(o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].endY[0]=o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].endY[0]+this.options.diffY)),"text"==o.history.options.arrData.name){for(var s=0;s<o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].finalTextInfo.length;s++)o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].finalTextInfo[s].x=o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].finalTextInfo[s].x+this.options.diffX,o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].finalTextInfo[s].y=o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].finalTextInfo[s].y+this.options.diffY;o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].textInfo.x+=this.options.diffX,o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].textInfo.y+=this.options.diffY}}else for(var s=0;s<o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].pencilData.length;s++)o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].pencilData[s].x=o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].pencilData[s].x+this.options.diffX,o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].pencilData[s].y=o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].pencilData[s].y+this.options.diffY;o.options.optionArrData=o.history.options.arrData={startX:[],startY:[],endX:[],endY:[],pencilData:[]},o.history.saveState(this.canvas),this.options.movedObject=-1,this.options.cursorStyle="default",o.options.toolsObj.canvas.style.cursor=this.options.cursorStyle,this.options.arrResize={startX:!1,startY:!1,endX:!1,endY:!1},this.options.isResize=!1,""!=this.options.prevTool&&(o.event.options.activeTool=this.options.prevTool,this.options.prevTool="")}},drawTool:function(){if(this.ctx.beginPath(),this.drawing){var t=o.history.options.arrData.name;"square"===t&&(o.square.init(this.canvas,this.ctx),o.square.options.startX=o.history.options.arrData.startX[0]+this.options.diffX,o.square.options.startY=o.history.options.arrData.startY[0]+this.options.diffY,o.square.options.endX=o.history.options.arrData.endX[0]+this.options.diffX,o.square.options.endY=o.history.options.arrData.endY[0]+this.options.diffY,o.square.drawTool())}this.ctx.stroke()},redrawTool:function(){var t=o.history.raw_undo_list[o.history.options.activePage],s=t.length-1;if(s>=0){for(i=0;i<=s;i++){if(this.ctx.beginPath(),o.history.options.font_size=t[i].font_size,o.history.options.fillStyle=t[i].fillStyle,o.history.options.lineWidth=t[i].lineWidth,o.history.setStyleElement(this.canvas,this.ctx),this.options.arrTool.indexOf(t[i].name)>-1){if("square"===t[i].name&&(this.options.currentDrawTool=o.square),"circle"===t[i].name&&(this.options.currentDrawTool=o.circle),"image"===t[i].name){this.options.currentDrawTool=o.image,this.options.currentDrawTool.options.img=t[i].imageURL;var n=new Image;n.onload=function(t){},n.src=this.options.currentDrawTool.options.img,this.options.currentDrawTool.options.img=n}if("line"===t[i].name&&(this.options.currentDrawTool=o.line),"arrow"===t[i].name&&(this.options.currentDrawTool=o.arrow),"ellipse"===t[i].name&&(this.options.currentDrawTool=o.ellipse),"text"===t[i].name&&(this.options.currentDrawTool=o.text),this.options.currentDrawTool.drawing=!0,this.options.movedObject==i&&1==this.options.isResize?(1==this.options.arrResize.startX?this.options.currentDrawTool.options.startX=o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].startX[0]+this.options.diffX:this.options.currentDrawTool.options.startX=o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].startX[0],1==this.options.arrResize.startY?this.options.currentDrawTool.options.startY=o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].startY[0]+this.options.diffY:this.options.currentDrawTool.options.startY=o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].startY[0],1==this.options.arrResize.endX?this.options.currentDrawTool.options.endX=o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].endX[0]+this.options.diffX:this.options.currentDrawTool.options.endX=o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].endX[0],1==this.options.arrResize.endY?this.options.currentDrawTool.options.endY=o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].endY[0]+this.options.diffY:this.options.currentDrawTool.options.endY=o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].endY[0]):this.options.movedObject==i?(this.options.currentDrawTool.options.startX=o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].startX[0]+this.options.diffX,this.options.currentDrawTool.options.startY=o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].startY[0]+this.options.diffY,this.options.currentDrawTool.options.endX=o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].endX[0]+this.options.diffX,this.options.currentDrawTool.options.endY=o.history.raw_undo_list[o.history.options.activePage][this.options.movedObject].endY[0]+this.options.diffY):(this.options.currentDrawTool.options.startX=t[i].startX[0],this.options.currentDrawTool.options.startY=t[i].startY[0],this.options.currentDrawTool.options.endX=t[i].endX[0],this.options.currentDrawTool.options.endY=t[i].endY[0]),"text"===t[i].name){var e=0,a=0;this.options.movedObject===i&&(e=this.options.diffX,a=this.options.diffY),this.options.currentDrawTool.redrawTool(t[i].finalTextInfo,e,a)}else this.options.currentDrawTool.drawTool();this.options.currentDrawTool.drawing=!1}else"pencil"===t[i].name&&(this.options.currentDrawTool=o.pencil,this.options.currentDrawTool.options.pencilData=t[i].pencilData,this.options.movedObject==i?(this.options.currentDrawTool.options.diffX=this.options.endX-this.options.startX,this.options.currentDrawTool.options.diffY=this.options.endY-this.options.startY):(this.options.currentDrawTool.options.diffX=0,this.options.currentDrawTool.options.diffY=0)),this.options.currentDrawTool&&(this.options.currentDrawTool.drawing=!0,"pencil"===t[i].name?this.options.currentDrawTool.redrawTool():this.options.currentDrawTool.drawTool(),this.options.currentDrawTool.drawing=!1);this.ctx.stroke()}var r=this.canvas.toDataURL();o.history.undo_list[o.history.options.activePage][0]=r,o.history.resetStyleElement()}},resizeCheck:function(t,o,i,s){this.options.startX>=t&&this.options.startX<=t+this.options.resizeMargin&&this.options.startY>=o&&this.options.startY<=o+this.options.resizeMargin?(this.options.arrResize.startX=!0,this.options.arrResize.startY=!0,this.options.arrResize.endX=!1,this.options.arrResize.endY=!1,this.options.cursorStyle="nwse-resize",this.options.isResize=!0):this.options.startX<=i&&this.options.startX>=i-this.options.resizeMargin&&this.options.startY<=s&&this.options.startY>=s-this.options.resizeMargin?(this.options.arrResize.startX=!1,this.options.arrResize.startY=!1,this.options.arrResize.endX=!0,this.options.arrResize.endY=!0,this.options.cursorStyle="nwse-resize",this.options.isResize=!0):this.options.startX>=t&&this.options.startX<=t+this.options.resizeMargin&&this.options.startY<=s&&this.options.startY>=s-this.options.resizeMargin?(this.options.arrResize.startX=!0,this.options.arrResize.startY=!1,this.options.arrResize.endX=!1,this.options.arrResize.endY=!0,this.options.cursorStyle="nesw-resize",this.options.isResize=!0):this.options.startX<=i&&this.options.startX>=i-this.options.resizeMargin&&this.options.startY>=o&&this.options.startY<=o+this.options.resizeMargin?(this.options.arrResize.startX=!1,this.options.arrResize.startY=!0,this.options.arrResize.endX=!0,this.options.arrResize.endY=!1,this.options.cursorStyle="nesw-resize",this.options.isResize=!0):this.options.startX>=t&&this.options.startX<=t+this.options.resizeMargin?(this.options.arrResize.startX=!0,this.options.arrResize.startY=!1,this.options.arrResize.endX=!1,this.options.arrResize.endY=!1,this.options.cursorStyle="ew-resize",this.options.isResize=!0):this.options.startX<=i&&this.options.startX>=i-this.options.resizeMargin?(this.options.arrResize.startX=!1,this.options.arrResize.startY=!1,this.options.arrResize.endX=!0,this.options.arrResize.endY=!1,this.options.cursorStyle="ew-resize",this.options.isResize=!0):this.options.startY>=o&&this.options.startY<=o+this.options.resizeMargin?(this.options.arrResize.startX=!1,this.options.arrResize.startY=!0,this.options.arrResize.endX=!1,this.options.arrResize.endY=!1,this.options.cursorStyle="ns-resize",this.options.isResize=!0):this.options.startY<=s&&this.options.startY>=s-this.options.resizeMargin&&(this.options.arrResize.startX=!1,this.options.arrResize.startY=!1,this.options.arrResize.endX=!1,this.options.arrResize.endY=!0,this.options.cursorStyle="ns-resize",this.options.isResize=!0)},hitTest:function(){var t=o.history.raw_undo_list[o.history.options.activePage],s=t.length-1;for(this.options.movedObject=-1,i=s;i>=0&&!(this.options.movedObject>-1);i--){if(o.history.options.arrData=t[i],"square"===o.history.options.arrData.name&&this.options.startX>=o.history.options.arrData.startX[0]&&this.options.startX<=o.history.options.arrData.endX[0]&&this.options.startY>=o.history.options.arrData.startY[0]&&this.options.startY<=o.history.options.arrData.endY[0]){this.options.movedObject=i;break}if("image"===o.history.options.arrData.name&&this.options.startX>=o.history.options.arrData.startX[0]&&this.options.startX<=o.history.options.arrData.endX[0]&&this.options.startY>=o.history.options.arrData.startY[0]&&this.options.startY<=o.history.options.arrData.endY[0]){this.options.movedObject=i,this.resizeCheck(o.history.options.arrData.startX[0],o.history.options.arrData.startY[0],o.history.options.arrData.endX[0],o.history.options.arrData.endY[0]);break}if("text"===o.history.options.arrData.name&&this.options.startX>=o.history.options.arrData.startX[0]&&this.options.startX<=o.history.options.arrData.endX[0]&&this.options.startY>=o.history.options.arrData.startY[0]&&this.options.startY<=o.history.options.arrData.endY[0]){this.options.movedObject=i;break}if("pencil"===o.history.options.arrData.name&&o.history.options.arrData.pencilData.length>0)for(c=0;c<o.history.options.arrData.pencilData.length;c++)if(parseInt(o.history.options.arrData.pencilData[c].x-4)<=this.options.startX&&parseInt(o.history.options.arrData.pencilData[c].x+4)>=this.options.startX&&parseInt(o.history.options.arrData.pencilData[c].y-4)<=this.options.startY&&parseInt(o.history.options.arrData.pencilData[c].y+4)>=this.options.startY){this.options.movedObject=i;break}if("circle"===o.history.options.arrData.name){var n=t[i].radius,e=t[i].startX[0]-this.options.startX,a=t[i].startY[0]-this.options.startY;if(parseInt(e*e+a*a)<parseInt(n*n)){this.options.movedObject=i;break}}if("ellipse"===o.history.options.arrData.name){for(var r=0,h=1e8,p=0,c=0*Math.PI;c<2*Math.PI;c+=.01)xPos=Math.floor(o.history.options.arrData.startX[0]-parseInt(o.history.options.arrData.endX[0]-o.history.options.arrData.startX[0])*Math.cos(c)),yPos=Math.floor(o.history.options.arrData.startY[0]+parseInt(o.history.options.arrData.endY[0]-o.history.options.arrData.startY[0])*Math.sin(c)),this.options.startX>=xPos-5&&this.options.startX<=xPos+5&&(this.options.startX==xPos&&(p=xPos),h>yPos&&(h=yPos),r<yPos&&(r=yPos));if(this.options.startX==p&&this.options.startY>h&&this.options.startY<r){this.options.movedObject=i;break}}if("line"===o.history.options.arrData.name){if(o.history.options.arrData.endX[0]<o.history.options.arrData.startX[0])var l=o.history.options.arrData.endX[0],d=o.history.options.arrData.startX[0];else var l=o.history.options.arrData.startX[0],d=o.history.options.arrData.endX[0];if(o.history.options.arrData.endY[0]<o.history.options.arrData.startY[0])var v=o.history.options.arrData.endY[0],u=o.history.options.arrData.startY[0];else var v=o.history.options.arrData.startY[0],u=o.history.options.arrData.endY[0];if(this.options.startX>=l&&this.options.startX<=d&&this.options.startY>=v&&this.options.startY<=u){var g=Math.atan2(this.options.startY-o.history.options.arrData.startY[0],this.options.startX-o.history.options.arrData.startX[0]),y=Math.abs(g)-Math.abs(o.history.options.arrData.lineAngle);if(Math.abs(y)<.2){this.options.movedObject=i;break}}}if("arrow"===o.history.options.arrData.name){if(o.history.options.arrData.endX[0]<o.history.options.arrData.startX[0])var l=o.history.options.arrData.endX[0],d=o.history.options.arrData.startX[0];else var l=o.history.options.arrData.startX[0],d=o.history.options.arrData.endX[0];if(o.history.options.arrData.endY[0]<o.history.options.arrData.startY[0])var v=o.history.options.arrData.endY[0],u=o.history.options.arrData.startY[0];else var v=o.history.options.arrData.startY[0],u=o.history.options.arrData.endY[0];if(this.options.startX>=l&&this.options.startX<=d&&this.options.startY>=v&&this.options.startY<=u){var g=Math.atan2(this.options.startY-o.history.options.arrData.startY[0],this.options.startX-o.history.options.arrData.startX[0]),y=Math.abs(g)-Math.abs(o.history.options.arrData.arrowAngle);if(Math.abs(y)<.2){this.options.movedObject=i;break}}}}}},o.square={name:"square",options:{stroke_color:["00","00","00"],dim:4},init:function(t,o){this.canvas=t,this.ctx=o,this.drawing=!1},start:function(t){this.canvas_coords=this.canvas.getBoundingClientRect();var o=t.pageX-this.canvas_coords.left,i=t.pageY-this.canvas_coords.top;this.options.startX=o,this.options.startY=i,this.options.endX=o,this.options.endY=i,this.ctx.beginPath(),this.drawing=!0},stroke:function(t){if(this.drawing){o.history.drawingState(this.canvas,this.ctx,o.history.undo_list),this.ctx.beginPath();var i=t.pageX-this.canvas_coords.left,s=t.pageY-this.canvas_coords.top;this.options.endX=i,this.options.endY=s,this.drawTool()}},stop:function(t){this.drawing&&this.options.startX!==this.options.endX&&this.options.startY!==this.options.endY?(this.ctx.beginPath(),this.options.width=this.options.endX-this.options.startX,this.options.height=this.options.endY-this.options.startY,this.drawTool(),this.ctx.stroke(),this.drawing=!1,o.history.setRawData(),o.history.saveState(this.canvas)):(this.ctx.closePath(),this.ctx.stroke(),this.drawing=!1)},drawLine:function(t,i){o.history.setStyleElement(this.canvas,this.ctx),this.ctx.moveTo(t.x,t.y),this.ctx.lineTo(i.x,i.y),this.ctx.stroke()},drawTool:function(){lineP1={x:this.options.startX,y:this.options.startY,r:0},lineP2={x:this.options.startX,y:this.options.endY,r:0},lineP3={x:this.options.endX,y:this.options.endY,r:0},lineP4={x:this.options.endX,y:this.options.startY,r:0},this.drawLine(lineP1,lineP2),this.drawLine(lineP2,lineP3),this.drawLine(lineP3,lineP4),this.drawLine(lineP4,lineP1)}},o.renderPage=function(t){var i=t.getViewport(o.options.pdfOptions.scale),s=document.createElement("canvas"),n=s.getContext("2d"),e={canvasContext:n,viewport:i};s.setAttribute("id","page"+t.pageIndex),s.height=i.height,s.width=i.width,o.history.options.canvas_width=s.width,o.history.options.canvas_height=s.height,o.options.toolsObj.canvasContainer.appendChild(s),task=t.render(e),task.promise.then(function(){o.options.bindCnt++,""===o.options.bindFlag&&t.transport.numPages==o.options.bindCnt&&(o.history.options.pdfobj=t,o.bindEvent(0),o.options.bindFlag=1)})},o.bindEvent=function(t){if(""==o.options.bindFlag){if(o.options.bindFlag="true",o.history.options.PrevPage=t,o.history.options.activePage=t,o.options.canvas=o.options.toolsObj.canvas,o.options.ctx=o.options.canvas.getContext("2d"),o.history.initial_canvas_url.hasOwnProperty(t))o.options.imgURL=o.history.final_canvas_url[o.history.options.activePage];else{var i=document.getElementById("page"+t);o.history.initial_canvas_url[t]=i.toDataURL(),o.history.final_canvas_url[o.history.options.activePage]=o.history.initial_canvas_url[o.history.options.activePage],o.options.imgURL=o.history.initial_canvas_url[o.history.options.activePage]}o.options.canvas.height=o.history.options.canvas_height,o.options.canvas.width=o.history.options.canvas_width;var s=document.createElement("img");s.src=o.options.imgURL,s.onload=function(){o.options.canvas_coords=o.options.canvas.getBoundingClientRect(),o.history.options.canvas_coords=o.options.canvas_coords,o.options.ctx.clearRect(0,0,o.options.canvas.width,o.options.canvas.height),o.options.ctx.drawImage(s,0,0,o.options.canvas.width,o.options.canvas.height),o.options.toolsObj.loading.textContent="",o.history.saveState(o.options.canvas),o.options.btnFlag===!1&&(o.options.btnFlag=!0,o.options.toolsObj.pencil.addEventListener("click",function(){o.event.options.activeTool=o.pencil,o.history.manageActiveBtn("pencil"),o.pencil.init(o.options.canvas,o.options.ctx)}),o.options.toolsObj.square.addEventListener("click",function(){o.event.options.activeTool=o.square,o.history.manageActiveBtn("square"),o.square.init(o.options.canvas,o.options.ctx)}),o.options.toolsObj.circle.addEventListener("click",function(){o.event.options.activeTool=o.circle,o.history.manageActiveBtn("circle"),o.circle.init(o.options.canvas,o.options.ctx)}),o.options.toolsObj.ellipse.addEventListener("click",function(){o.event.options.activeTool=o.ellipse,o.history.manageActiveBtn("ellipse"),o.ellipse.init(o.options.canvas,o.options.ctx)}),o.options.toolsObj.text.addEventListener("click",function(){o.event.options.activeTool=o.text,o.history.manageActiveBtn("text"),o.text.init(o.options.canvas,o.options.ctx)}),o.options.toolsObj.contenteditor.addEventListener("blur",function(){o.options.toolsObj.editor_wrapper.style.display="none",o.text.drawTool()}),o.options.toolsObj.arrow.addEventListener("click",function(){o.event.options.activeTool=o.arrow,o.history.manageActiveBtn("arrow"),o.arrow.init(o.options.canvas,o.options.ctx)}),o.options.toolsObj.line.addEventListener("click",function(){o.event.options.activeTool=o.line,o.history.manageActiveBtn("line"),o.line.init(o.options.canvas,o.options.ctx)}),o.options.toolsObj.imageupload.addEventListener("change",function(){o.image.uploadImage(this.files[0]),o.event.options.activeTool=o.image,o.history.manageActiveBtn("clear_image"),o.image.init(o.options.canvas,o.options.ctx)}),o.options.toolsObj.clear_image.addEventListener("click",function(){o.options.toolsObj.frm_canvas_tool.reset()}),o.options.toolsObj.undo.addEventListener("click",function(){o.history.undo(o.options.canvas,o.options.ctx)}),o.options.toolsObj.redo.addEventListener("click",function(){o.history.redo(o.options.canvas,o.options.ctx)}),o.options.toolsObj.save.addEventListener("click",function(){o.event.options.activeTool="",o.history.manageActiveBtn(""),o.event.savepdf()}),o.options.toolsObj.fontsize.addEventListener("change",function(){o.history.options.font_size=this.value}),o.options.toolsObj.fillstyle.addEventListener("change",function(){o.history.options.fillStyle="#"+this.value}),o.options.toolsObj.linewidth.addEventListener("change",function(){o.history.options.lineWidth=this.value}),o.options.toolsObj.prevBtn.addEventListener("click",function(){o.options.toolsObj.prevBtn.getAttribute("disable")||(o.options.bindFlag="",o.bindEvent(parseInt(o.history.options.activePage-1)))}),o.options.toolsObj.nextBtn.addEventListener("click",function(){o.options.toolsObj.nextBtn.getAttribute("disabled")||(o.options.bindFlag="",o.bindEvent(parseInt(o.history.options.activePage+1)))}),o.options.toolsObj.fontsize.value=o.history.options.font_size,o.options.toolsObj.fillstyle.value=o.history.options.fillStyle,o.options.toolsObj.linewidth.value=o.history.options.lineWidth),o.event.init(o.options.canvas,o.options.ctx),o.history.setButtonStyle()}}},o.renderPages=function(t){o.history.options.numPages=t.numPages;for(var i=1;i<=t.numPages;i++)t.getPage(i).then(o.renderPage)},o.renderPDF=function(t,i,s){this.options.pdfOptions=s||{scale:2},o.options.toolsObj.loading.textContent="Wait while loading PDF file...",PDFJS.disableWorker=!1,PDFJS.getDocument(t).then(o.renderPages)},o})}),$(window).scroll(function(){var t=90,o=$(window).scrollTop();o>t?$("#controllers").css({position:"fixed"}):$("#controllers").css({position:"relative"})});